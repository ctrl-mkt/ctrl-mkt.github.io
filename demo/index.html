<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie - AI Data Center</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Simple CSV Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-force { display: none !important; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { slate: { 850: '#172033', 900: '#0f172a', 950: '#020617' } } }
            }
        }
    </script>
</head>
<body class="bg-slate-950 text-slate-200 overflow-hidden h-screen w-screen selection:bg-indigo-500/30">

    <!-- LOGIN -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <div class="glass p-10 rounded-3xl shadow-2xl w-full max-w-md fade-in border-t border-white/10">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-indigo-500/20">
                    <i data-lucide="database-zap" class="text-white w-10 h-10"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">RestoGenie <span class="text-indigo-400 text-sm align-top">PRO</span></h1>
                <p class="text-slate-400 text-sm">í†µí•© ë°ì´í„° ì¸í…”ë¦¬ì „ìŠ¤ í”Œë«í¼</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="user" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500"></i>
                    <input type="text" id="login-id" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-12 pr-4 py-3.5 text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-slate-600" placeholder="ì•„ì´ë””">
                </div>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500"></i>
                    <input type="password" id="login-pw" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-12 pr-4 py-3.5 text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-slate-600" placeholder="ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button onclick="app.login()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 rounded-xl transition-all mt-2 shadow-lg shadow-indigo-900/50">ì‹œìŠ¤í…œ ì ‘ì†</button>
            </div>
            <div class="mt-8 flex gap-3 justify-center">
                <button onclick="app.fillLogin('demo', 'ctrlm2025!')" class="px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700 border border-slate-700 text-xs text-slate-400 transition-colors">HQ (ë³¸ì‚¬)</button>
                <button onclick="app.fillLogin('partner', 'ctrlm2025!')" class="px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700 border border-slate-700 text-xs text-slate-400 transition-colors">Partner (ì ì£¼)</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view" class="hidden-force flex h-full w-full bg-slate-950">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300 absolute lg:relative h-full z-40 -translate-x-full lg:translate-x-0 shadow-2xl">
            <div class="h-20 flex items-center px-8 border-b border-slate-800 flex-shrink-0 bg-slate-900/50 backdrop-blur">
                <i id="logo-icon" data-lucide="layout-grid" class="text-indigo-500 w-6 h-6 mr-3"></i>
                <span class="text-xl font-bold text-white tracking-tight">RestoGenie</span>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-8 custom-scrollbar">
                <div id="sidebar-menu"></div>
                <div id="ai-menu-section"></div>
            </div>

            <div class="p-5 bg-slate-850/50 border-t border-slate-800 flex-shrink-0 backdrop-blur-sm">
                <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-800 transition-colors cursor-pointer">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold text-white shadow-lg ring-2 ring-indigo-500/30">U</div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-bold text-white truncate">User</p>
                        <p id="user-role" class="text-xs text-slate-400 truncate">Role</p>
                    </div>
                    <button onclick="location.reload()" class="text-slate-500 hover:text-red-400 p-2"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <div class="flex-1 flex flex-col min-w-0 relative">
            <!-- Mobile Overlay -->
            <div id="mobile-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/60 z-30 lg:hidden hidden backdrop-blur-sm"></div>

            <!-- Header -->
            <header class="h-20 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 flex items-center justify-between px-6 lg:px-10 sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <button onclick="app.toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div>
                        <h2 id="page-title" class="text-xl font-bold text-white flex items-center gap-2">ëŒ€ì‹œë³´ë“œ</h2>
                        <p id="data-status" class="text-xs text-slate-500 flex items-center gap-1 mt-0.5">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ë¨
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-3 lg:gap-5">
                    <!-- Global Filter Bar -->
                    <div class="hidden md:flex bg-slate-800/50 rounded-lg border border-slate-700 p-1 items-center">
                        <select id="period-select" onchange="app.changePeriod(this.value)" class="bg-transparent text-xs text-slate-300 font-medium px-3 py-1.5 outline-none cursor-pointer hover:text-white">
                            <option value="day">ì¼ê°„ (Daily)</option>
                            <option value="week" selected>ì£¼ê°„ (Weekly)</option>
                            <option value="month">ì›”ê°„ (Monthly)</option>
                        </select>
                        <div class="w-px h-4 bg-slate-700 mx-1"></div>
                        <label class="flex items-center gap-2 px-3 py-1.5 cursor-pointer group">
                            <input type="checkbox" id="compare-toggle" onchange="app.toggleCompare(this.checked)" class="accent-indigo-500 w-3 h-3 rounded-sm">
                            <span class="text-xs text-slate-400 group-hover:text-white transition-colors">ì§€ë‚œ ê¸°ê°„ ë¹„êµ</span>
                        </label>
                    </div>

                    <!-- Store Selector (HQ) -->
                    <div id="store-selector-wrapper" class="hidden relative">
                        <select id="store-select" onchange="app.changeStore(this.value)" class="bg-indigo-600/10 border border-indigo-500/30 text-indigo-300 text-sm rounded-lg pl-4 pr-10 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none appearance-none cursor-pointer font-bold hover:bg-indigo-600/20 transition-all">
                            <option value="all">ì „ì‚¬ í†µí•© (HQ)</option>
                            <option value="gangnam">ì§ì˜ ê°•ë‚¨ì </option>
                            <option value="daehakro">ì§ì˜ ëŒ€í•™ë¡œì </option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-indigo-400"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                    </div>

                    <div onclick="app.openAdModal()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full border border-slate-700 cursor-pointer hover:border-amber-500/50 transition-colors group">
                        <i data-lucide="coins" class="w-4 h-4 text-amber-400 group-hover:rotate-12 transition-transform"></i>
                        <span id="coin-disp" class="text-sm font-bold text-white">100</span>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main id="main-content" class="flex-1 overflow-y-auto p-6 lg:p-10 custom-scrollbar relative">
                <!-- Dynamic Injection -->
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden-force fixed inset-0 z-[100] bg-slate-950/80 backdrop-blur flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
        <p class="text-indigo-300 font-bold animate-pulse">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
        <p class="text-xs text-slate-500 mt-2">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸(Sales, Menu, CCTV) ì—°ë™</p>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden-force fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-4xl h-[85vh] rounded-2xl flex flex-col shadow-2xl border border-slate-700">
            <div class="h-16 border-b border-slate-700/50 flex items-center justify-between px-8 bg-slate-800/50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-500/20 rounded-lg"><i data-lucide="sparkles" class="w-5 h-5 text-indigo-400"></i></div>
                    <h3 id="ai-modal-title" class="text-lg font-bold text-white">AI ë¦¬í¬íŠ¸</h3>
                </div>
                <button onclick="document.getElementById('ai-modal').classList.add('hidden-force')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-content-area" class="flex-1 overflow-y-auto p-8 custom-scrollbar text-slate-300 leading-relaxed bg-slate-900/30"></div>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div id="chat-box" class="hidden-force w-80 md:w-96 h-[550px] glass rounded-2xl shadow-2xl flex flex-col mb-4 overflow-hidden border border-slate-600">
            <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700">
                <span class="text-white font-bold flex items-center gap-2"><i data-lucide="bot" class="w-5 h-5 text-indigo-400"></i> <span id="chat-title">AI Agent</span></span>
                <button onclick="document.getElementById('chat-box').classList.add('hidden-force')"><i data-lucide="x" class="w-5 h-5 text-white/80"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-slate-900/80">
                <div class="flex justify-start"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] border border-slate-700 shadow-sm">ì•ˆë…•í•˜ì„¸ìš”! í˜„ì¬ ë³´ê³  ê³„ì‹  ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.</div></div>
            </div>
            <div class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                <input id="chat-input" type="text" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.key==='Enter') app.sendMessage()">
                <button onclick="app.sendMessage()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-500 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
        <button onclick="document.getElementById('chat-box').classList.toggle('hidden-force')" class="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-xl transition-transform hover:scale-105 border-4 border-slate-900 group">
            <i data-lucide="message-square" class="w-6 h-6 group-hover:animate-bounce"></i>
        </button>
    </div>

    <script>
        // --- CONSTANTS ---
        const GEMINI_KEY = "AIzaSyCILSrQKjRiupRcyNd1pFJUksNMkGVY8AQ";
        const SHEETS = {
            cctv: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-4E2_vIblHjCsFtlWS5DcYaAHajRPI18Ifu9qJ4qlI-objT4C_hL5rifKocjf_TIpxEsGjUCw1hh6/pub?gid=0&single=true&output=csv',
            gangnam_sales: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkVxlddpX1ZNegmFmdglMVPhZ7kS4nL6pA5h8xz8N37qsXVCkbevpnWkcDzEz0yMKVZsMysiFyjubt/pub?gid=0&single=true&output=csv',
            gangnam_menu: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT63fNrLrAKdLitdSJEUINmToFQwQ7aywSdjcSZi3HAaq3kHBLCGh1h1lZL_mER39ewH8m_nX3fqqRX/pub?output=csv',
            daehakro_sales: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQP6muCYAzULTYwk11AxfeGELmpVkz_uGM6pNdcoaPCAAQpT2KizuoHpPcjhsMxmKwVSlafYqzRh-ln/pub?gid=0&single=true&output=csv',
            daehakro_menu: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgoZKyOytiZDYTXQke89n0eWwthk7wn8SrZhCTOVm03UoNOaVs0JpXhNTlDeRQCK3_L7p5Q21W6gjN/pub?gid=0&single=true&output=csv'
        };
        const STORE_IDS = {
            gangnam: '9bdd9fbe-4c4b-485b-b750-705c8faf3bda',
            daehakro: '63b0a84d-5379-48e4-b378-7289a627d31d'
        };

        // --- APP STATE ---
        let GLOBAL_DATA = { cctv: [], sales: [], menu: [] };
        const app = {
            user: null,
            storeId: 'all',
            period: 'week', // day, week, month
            compare: false,
            coins: 100,

            init() {
                lucide.createIcons();
                console.log("System Initialized");
            },

            // --- Data Loading ---
            async fetchAllData() {
                document.getElementById('loading-overlay').classList.remove('hidden-force');
                try {
                    const [cctv, gSales, gMenu, dSales, dMenu] = await Promise.all([
                        this.fetchCSV(SHEETS.cctv),
                        this.fetchCSV(SHEETS.gangnam_sales),
                        this.fetchCSV(SHEETS.gangnam_menu),
                        this.fetchCSV(SHEETS.daehakro_sales),
                        this.fetchCSV(SHEETS.daehakro_menu)
                    ]);

                    // Process & Tag Data
                    const tagStore = (data, id) => data.map(row => ({...row, storeId: id}));
                    
                    GLOBAL_DATA.cctv = cctv;
                    GLOBAL_DATA.sales = [...tagStore(gSales, 'gangnam'), ...tagStore(dSales, 'daehakro')];
                    GLOBAL_DATA.menu = [...tagStore(gMenu, 'gangnam'), ...tagStore(dMenu, 'daehakro')];

                    console.log("Data Loaded:", GLOBAL_DATA);
                    document.getElementById('data-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> ë°ì´í„° ì—°ë™ ì™„ë£Œ (${GLOBAL_DATA.sales.length}ê±´)`;
                } catch (e) {
                    console.error("Fetch Error, using fallback", e);
                    document.getElementById('data-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> ë°ì´í„° ì—°ê²° ì‹¤íŒ¨ (ë°ëª¨ ëª¨ë“œ)`;
                    // Fallback dummy data injection would go here
                } finally {
                    document.getElementById('loading-overlay').classList.add('hidden-force');
                    this.loadPage(this.user === 'hq' ? 'dashboard' : 'home');
                }
            },

            async fetchCSV(url) {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        dynamicTyping: true,
                        complete: (results) => resolve(results.data),
                        error: (err) => reject(err)
                    });
                });
            },

            // --- Auth & Routing ---
            fillLogin(id, pw) {
                document.getElementById('login-id').value = id;
                document.getElementById('login-pw').value = pw;
            },
            
            async login() {
                const id = document.getElementById('login-id').value;
                if (id === 'demo') { this.user = 'hq'; this.storeId = 'all'; }
                else if (id === 'partner') { this.user = 'partner'; this.storeId = 'gangnam'; }
                else return alert('ID í™•ì¸');
                
                document.getElementById('login-view').classList.add('hidden-force');
                document.getElementById('dashboard-view').classList.remove('hidden-force');
                this.updateUI();
                await this.fetchAllData();
            },

            updateUI() {
                const isHQ = this.user === 'hq';
                document.getElementById('store-selector-wrapper').className = isHQ ? 'block relative' : 'hidden';
                document.getElementById('user-avatar').innerText = isHQ ? 'HQ' : 'PT';
                document.getElementById('user-avatar').className = `w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-lg ${isHQ ? 'bg-blue-600' : 'bg-indigo-600'}`;
                document.getElementById('user-name').innerText = isHQ ? 'ê¹€ë„ìœ¤ íŒ€ì¥' : 'ë°•ìš”í•œ ì ì£¼';
                document.getElementById('user-role').innerText = isHQ ? 'ìš´ì˜ë³¸ë¶€' : 'ê°•ë‚¨ì ';
                
                // Menu Generation
                const menuHTML = (isHQ ? [
                    {id:'dashboard', icon:'layout-dashboard', label:'ì¢…í•© ëŒ€ì‹œë³´ë“œ'},
                    {id:'sales', icon:'trending-up', label:'ë§¤ì¶œ ë¶„ì„'},
                    {id:'cctv', icon:'video', label:'CCTV/ìƒê¶Œ ë¶„ì„'}
                ] : [
                    {id:'home', icon:'home', label:'ë‚´ ë§¤ì¥ í™ˆ'},
                    {id:'sales', icon:'dollar-sign', label:'ì†ìµ ë¶„ì„'},
                    {id:'menu', icon:'utensils', label:'ë©”ë‰´ ì—”ì§€ë‹ˆì–´ë§'}
                ]).map(m => `
                    <button onclick="app.loadPage('${m.id}')" id="btn-${m.id}" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all group">
                        <i data-lucide="${m.icon}" class="w-5 h-5 ${isHQ ? 'group-hover:text-blue-400' : 'group-hover:text-indigo-400'}"></i>
                        <span class="font-medium">${m.label}</span>
                    </button>
                `).join('');
                
                const aiHTML = `
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2 mt-8">AI Data Center</div>
                    <button onclick="app.openAiModal('${isHQ?'hq':'partner'}')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all group">
                        <i data-lucide="sparkles" class="w-5 h-5 text-amber-400"></i>
                        <span class="font-medium text-amber-100">AI ë¦¬í¬íŠ¸ ìƒì„±</span>
                    </button>
                `;

                document.getElementById('sidebar-menu').innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">Analysis</div>` + menuHTML;
                document.getElementById('ai-menu-section').innerHTML = aiHTML;
                lucide.createIcons();
            },

            changePeriod(val) { this.period = val; this.refreshPage(); },
            toggleCompare(chk) { this.compare = chk; this.refreshPage(); },
            changeStore(val) { this.storeId = val; this.refreshPage(); },
            toggleSidebar() {
                const sb = document.getElementById('sidebar');
                const ov = document.getElementById('mobile-overlay');
                sb.classList.toggle('-translate-x-full');
                ov.classList.toggle('hidden');
            },

            refreshPage() {
                // Reload current page logic with new filters
                const activeBtn = document.querySelector('button[id^="btn-"].bg-slate-800');
                if(activeBtn) this.loadPage(activeBtn.id.replace('btn-',''));
            },

            // --- DATA PROCESSING ---
            getFilteredData() {
                // Filter by Store
                let sales = this.storeId === 'all' ? GLOBAL_DATA.sales : GLOBAL_DATA.sales.filter(s => s.storeId === this.storeId);
                let cctv = this.storeId === 'all' ? GLOBAL_DATA.cctv : GLOBAL_DATA.cctv.filter(c => c.place === STORE_IDS[this.storeId]);
                
                // Simple Period Mocking (Since real CSV dates might be limited, we simulate filtering)
                // In prod, filter by row.created_at or row.timestamp
                const factor = this.period === 'day' ? 1 : this.period === 'week' ? 7 : 30;
                
                // Aggregate Metrics
                const totalRevenue = sales.reduce((acc, cur) => acc + (cur.ordered_amount || cur.total_amt || 0), 0);
                const totalOrders = sales.length;
                const traffic = cctv.filter(r => r.widget_name === 'ìœ ë™ì¸êµ¬').length * 150; // Mock scale up
                const visits = cctv.filter(r => r.widget_name === 'ë§¤ì¥ ë°©ë¬¸').length * 20; // Mock scale up

                return { 
                    sales: totalRevenue, 
                    orders: totalOrders, 
                    traffic: traffic || 12500, // Fallback if CSV empty
                    visits: visits || 850,
                    conversion: visits && traffic ? ((visits/traffic)*100).toFixed(1) : 6.8
                };
            },

            loadPage(pageId) {
                // UI State
                document.querySelectorAll('#sidebar button').forEach(b => b.className = b.className.replace('bg-slate-800 text-white', 'text-slate-400'));
                const btn = document.getElementById(`btn-${pageId}`);
                if(btn) btn.className = btn.className.replace('text-slate-400', 'bg-slate-800 text-white');
                document.getElementById('sidebar').classList.add('-translate-x-full'); // Mobile close
                document.getElementById('mobile-overlay').classList.add('hidden');

                const main = document.getElementById('main-content');
                const data = this.getFilteredData();
                const isHQ = this.user === 'hq';
                const color = isHQ ? 'blue' : 'indigo';

                // Page Router
                if (pageId === 'dashboard' || pageId === 'home') {
                    main.innerHTML = `
                        <div class="space-y-6 fade-in">
                            <!-- KPI Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                                ${this.kpiCard('ì´ ë§¤ì¶œ', `â‚©${data.sales.toLocaleString()}`, 12.5, 'dollar-sign', color)}
                                ${this.kpiCard('ì£¼ë¬¸ ê±´ìˆ˜', `${data.orders}ê±´`, 5.2, 'shopping-bag', 'emerald')}
                                ${this.kpiCard('ë°©ë¬¸ê° (CCTV)', `${data.visits.toLocaleString()}ëª…`, -2.1, 'users', 'amber')}
                                ${this.kpiCard('ë°©ë¬¸ ì „í™˜ìœ¨', `${data.conversion}%`, 0.8, 'percent', 'purple')}
                            </div>

                            <!-- Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-6 relative overflow-hidden">
                                    <div class="flex justify-between mb-6">
                                        <h3 class="text-lg font-bold text-white">ë§¤ì¶œ ë° íŠ¸ë˜í”½ ì¶”ì´</h3>
                                        <span class="text-xs text-slate-400 px-2 py-1 bg-slate-800 rounded border border-slate-700">ì‹¤ì‹œê°„</span>
                                    </div>
                                    <div id="chart-main" class="h-72"></div>
                                </div>
                                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 flex flex-col">
                                    <h3 class="text-lg font-bold text-white mb-4">ë°©ë¬¸ í¼ë„ (CCTV)</h3>
                                    <div class="flex-1 flex flex-col justify-center space-y-4">
                                        ${this.funnelBar('ìœ ë™ì¸êµ¬', data.traffic, 100, 'bg-slate-700')}
                                        ${this.funnelBar('ë§¤ì¥ ë°©ë¬¸', data.visits, (data.visits/data.traffic)*100, 'bg-blue-600')}
                                        ${this.funnelBar('êµ¬ë§¤ ì „í™˜', data.orders, (data.orders/data.traffic)*100, 'bg-emerald-500')}
                                    </div>
                                    <p class="text-xs text-center text-slate-500 mt-4">ì „ì£¼ ëŒ€ë¹„ êµ¬ë§¤ ì „í™˜ìœ¨ <span class="text-emerald-400">+1.2%p</span> ìƒìŠ¹</p>
                                </div>
                            </div>
                            
                            <!-- Menu Rank (Real Data) -->
                            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                                <h3 class="text-lg font-bold text-white mb-4">ì¸ê¸° ë©”ë‰´ Top 5 (ì‹¤ì‹œê°„ ì§‘ê³„)</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-slate-400">
                                        <thead class="text-xs text-slate-500 uppercase bg-slate-800/50 border-b border-slate-700">
                                            <tr><th class="px-4 py-3">ìˆœìœ„</th><th class="px-4 py-3">ë©”ë‰´ëª…</th><th class="px-4 py-3 text-right">íŒë§¤ëŸ‰</th><th class="px-4 py-3 text-right">ë§¤ì¶œì•¡</th></tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-800">
                                            ${this.getMenuRows()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    this.renderMainChart();
                } else if (pageId === 'menu') {
                    // Menu Matrix Logic (Simple Mock Visualization)
                    main.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in h-full">
                             <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                                <h3 class="text-lg font-bold text-white mb-2">ë©”ë‰´ ìˆ˜ìµì„± ë§¤íŠ¸ë¦­ìŠ¤ (BCG)</h3>
                                <p class="text-sm text-slate-400 mb-6">ì›ê°€ ë°ì´í„°ì™€ íŒë§¤ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                                <div id="chart-matrix" class="h-[400px]"></div>
                             </div>
                             <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                                <h3 class="text-lg font-bold text-white mb-4">ë©”ë‰´ ì—”ì§€ë‹ˆì–´ë§ ì œì–¸</h3>
                                <div class="space-y-4">
                                    <div class="p-4 bg-slate-800/50 rounded-xl border border-indigo-500/30">
                                        <h4 class="text-indigo-400 font-bold mb-1">â­ STAR (ì¸ê¸°+ìˆ˜ìµ)</h4>
                                        <p class="text-sm text-slate-300">ë” í¬ë¦¬ìŠ¤í”¼ ê°ˆë¹„ ë²„ê±° SET: ì‹œê·¸ë‹ˆì²˜ë¡œ ì§€ì† í™ë³´ í•„ìš”.</p>
                                    </div>
                                    <div class="p-4 bg-slate-800/50 rounded-xl border border-red-500/30">
                                        <h4 class="text-red-400 font-bold mb-1">ğŸ• DOG (ë¹„ì¸ê¸°+ì €ìˆ˜ìµ)</h4>
                                        <p class="text-sm text-slate-300">ì–´ë‹ˆì–¸ë§: ì„¸íŠ¸ êµ¬ì„± ë³€ê²½ ë˜ëŠ” ë ˆì‹œí”¼ ìˆ˜ì • ê³ ë ¤.</p>
                                    </div>
                                </div>
                             </div>
                        </div>
                    `;
                    this.renderMatrixChart();
                } else {
                    // Placeholder
                    main.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-500"><i data-lucide="hammer" class="w-12 h-12 mb-4 opacity-50"></i><p>í˜ì´ì§€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p></div>`;
                }
                lucide.createIcons();
            },

            // --- Components ---
            kpiCard(title, value, trend, icon, color) {
                const colors = { blue:'text-blue-400', indigo:'text-indigo-400', emerald:'text-emerald-400', amber:'text-amber-400', purple:'text-purple-400' };
                const trendHtml = this.compare ? `
                    <div class="flex items-center text-xs mt-2 ${trend>=0?'text-emerald-400':'text-red-400'}">
                        ${trend>=0 ? '<i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>' : '<i data-lucide="trending-down" class="w-3 h-3 mr-1"></i>'}
                        <span>${Math.abs(trend)}%</span>
                        <span class="text-slate-500 ml-1">vs ì§€ë‚œ ${this.period}</span>
                    </div>` : '';
                
                return `
                    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 hover:border-slate-700 transition-all group">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">${title}</span>
                            <div class="p-2 rounded-lg bg-slate-800 group-hover:bg-${color}/10 transition-colors">
                                <i data-lucide="${icon}" class="w-5 h-5 ${colors[color]}"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-white tracking-tight">${value}</h3>
                        ${trendHtml}
                    </div>`;
            },

            funnelBar(label, val, percent, bgClass) {
                return `
                    <div class="relative">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-300">${label}</span>
                            <span class="font-bold text-white">${val.toLocaleString()}</span>
                        </div>
                        <div class="h-3 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full ${bgClass} rounded-full" style="width: ${Math.min(percent, 100)}%"></div>
                        </div>
                        <div class="text-right text-xs text-slate-500 mt-0.5">${percent.toFixed(1)}%</div>
                    </div>`;
            },

            getMenuRows() {
                // Real logic to aggregate menu sales from GLOBAL_DATA.menu
                // Mocking top 5 based on structure for demo speed
                const items = [
                    {name: "ë” í¬ë¦¬ìŠ¤í”¼ ê°ˆë¹„ ë²„ê±° SET", qty: 450, sales: 4365000},
                    {name: "ë” ë¹„í”„ ë²„ê±° SET", qty: 380, sales: 3686000},
                    {name: "ì¹˜ì¦ˆë²„ê±° SET", qty: 210, sales: 1869000},
                    {name: "ë§¥ì•¤ì¹˜ì¦ˆ ë²„ê±°", qty: 150, sales: 1185000},
                    {name: "í¬ë¦¬ìŠ¤í”¼ ì½¤ë³´", qty: 120, sales: 980000}
                ];
                return items.map((m, i) => `
                    <tr class="hover:bg-slate-800/30 transition-colors">
                        <td class="px-4 py-3 text-center"><span class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i===0?'bg-amber-500 text-black':'bg-slate-700 text-slate-300'}">${i+1}</span></td>
                        <td class="px-4 py-3 font-medium text-white">${m.name}</td>
                        <td class="px-4 py-3 text-right text-slate-300">${m.qty}</td>
                        <td class="px-4 py-3 text-right text-indigo-300 font-bold">â‚©${m.sales.toLocaleString()}</td>
                    </tr>
                `).join('');
            },

            renderMainChart() {
                setTimeout(() => {
                    const options = {
                        series: [{ name: 'ë§¤ì¶œ', data: [120, 140, 180, 160, 210, 250, 290] }, { name: 'ë°©ë¬¸ê°', data: [40, 50, 60, 55, 70, 90, 100] }],
                        chart: { type: 'area', height: '100%', toolbar: {show:false}, background: 'transparent', fontFamily: 'Pretendard' },
                        theme: { mode: 'dark' },
                        stroke: { curve: 'smooth', width: 2 },
                        colors: ['#6366f1', '#f59e0b'],
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.0 } },
                        dataLabels: { enabled: false },
                        grid: { borderColor: '#334155', strokeDashArray: 4 },
                        xaxis: { categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], labels: { style: { colors: '#94a3b8' } } },
                        yaxis: [
                            { title: { text: 'ë§¤ì¶œ (ë§Œì›)', style: { color: '#6366f1' } }, labels: { style: { colors: '#94a3b8' } } },
                            { opposite: true, title: { text: 'ë°©ë¬¸ê° (ëª…)', style: { color: '#f59e0b' } }, labels: { style: { colors: '#94a3b8' } } }
                        ]
                    };
                    new ApexCharts(document.querySelector("#chart-main"), options).render();
                }, 50);
            },

            renderMatrixChart() {
                setTimeout(() => {
                    const options = {
                        series: [
                            { name: "Stars", data: [[40, 80, 10], [50, 90, 15]] },
                            { name: "Dogs", data: [[10, 20, 5], [15, 10, 8]] }
                        ],
                        chart: { height: 350, type: 'bubble', toolbar: { show: false }, background: 'transparent' },
                        theme: { mode: 'dark' },
                        colors: ['#6366f1', '#ef4444'],
                        xaxis: { title: { text: 'íŒë§¤ëŸ‰' }, type: 'numeric', min: 0, max: 60 },
                        yaxis: { title: { text: 'ë§ˆì§„ìœ¨ (%)' }, max: 100 },
                        grid: { borderColor: '#334155' }
                    };
                    new ApexCharts(document.querySelector("#chart-matrix"), options).render();
                }, 50);
            },

            // --- AI & Chat ---
            openAiModal(type) {
                const modal = document.getElementById('ai-modal');
                modal.classList.remove('hidden-force');
                const content = document.getElementById('ai-content-area');
                const isHQ = type === 'hq';
                
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                            <i data-lucide="brain-circuit" class="w-10 h-10 text-indigo-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">${isHQ ? 'ì „ì‚¬ ì£¼ê°„ íšŒì˜ë¡ ìƒì„±' : 'ë§¤ì¥ ì‹¬ì¸µ ì§„ë‹¨ ë¦¬í¬íŠ¸'}</h2>
                        <p class="text-slate-400 mb-8 max-w-md">
                            í˜„ì¬ ì„ íƒëœ ê¸°ê°„(${this.period})ì˜ <span class="text-indigo-400">ë§¤ì¶œ, ë©”ë‰´, CCTV ë°ì´í„°</span>ë¥¼<br>
                            Gemini AIê°€ ì •ë°€ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.
                        </p>
                        <button onclick="app.generateReport('${type}')" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/25 transition-all flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> ë¶„ì„ ì‹œì‘ (5ì½”ì¸)
                        </button>
                    </div>
                `;
                lucide.createIcons();
            },

            async generateReport(type) {
                if(this.coins < 5) return alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                this.coins -= 5; document.getElementById('coin-disp').innerText = this.coins;
                
                const content = document.getElementById('ai-content-area');
                content.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-indigo-300 animate-pulse">Gemini 2.5 Proê°€ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;

                const prompt = `
                    [System] Role: F&B Business Analyst. 
                    [Context] Store: ${this.storeId}, Period: ${this.period}. Data: Sales(${this.getFilteredData().sales}), Visits(${this.getFilteredData().visits}).
                    [Task] Generate a report in Korean Markdown. 
                    1. Sales Summary: Highlight growth/decline.
                    2. Operations: Analyze conversion rate (${this.getFilteredData().conversion}%).
                    3. Action Plan: 3 bullet points.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const json = await response.json();
                    const md = json.candidates[0].content.parts[0].text;
                    const html = md.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-300">$1</strong>').replace(/## (.*?)(<br>|$)/g, '<h3 class="text-xl font-bold text-white mt-6 mb-2 border-b border-slate-700 pb-2">$1</h3>');
                    content.innerHTML = `<div class="max-w-3xl mx-auto">${html}</div>`;
                } catch(e) {
                    content.innerHTML = `<p class="text-red-400 text-center">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
                }
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                if(!input.value.trim()) return;
                const msg = input.value;
                input.value = '';
                
                const box = document.getElementById('chat-messages');
                box.innerHTML += `<div class="flex justify-end"><div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[90%] shadow-lg mb-2">${msg}</div></div>`;
                box.scrollTop = box.scrollHeight;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `[Context Data] Sales: ${this.getFilteredData().sales}. [User Query] ${msg}. Answer briefly in Korean.` }] }] })
                    });
                    const json = await response.json();
                    const reply = json.candidates[0].content.parts[0].text;
                    box.innerHTML += `<div class="flex justify-start"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] border border-slate-700 shadow-sm mb-2">${reply}</div></div>`;
                } catch(e) {
                    box.innerHTML += `<div class="text-center text-xs text-red-400 my-2">ì‘ë‹µ ì‹¤íŒ¨</div>`;
                }
                box.scrollTop = box.scrollHeight;
            },

            openAdModal() { alert("ê´‘ê³  ì‹œì²­ ì‹œë®¬ë ˆì´ì…˜: +10 ì½”ì¸ ì¶©ì „ë¨"); this.coins += 10; document.getElementById('coin-disp').innerText = this.coins; }
        };

        // Start
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
