<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slam Burger Manager</title>
    
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configure Tailwind theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slam: {
                            red: '#E31937', // Slam Burger Main Red
                            dark: '#1A1A1A',
                            gray: '#F2F4F6', // Toss style background
                            text: '#333D4B',
                            light: '#E5E8EB'
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', 'sans-serif'],
                    },
                    boxShadow: {
                        'toss': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'floating': '0 8px 30px rgba(227, 25, 55, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-in-right { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-in-right.active { transform: translateX(0); }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .mobile-hide { display: none; }
        }
    </style>
</head>
<body class="bg-slam-gray text-slam-text font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Login / Shift Select Modal -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="w-full max-w-md space-y-8 text-center">
            <h1 class="text-4xl font-bold text-slam-red tracking-tighter">SLAM BURGER</h1>
            <p class="text-gray-500">ë§¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ ì ‘ì†</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium mb-1">ì§ì› ì´ë¦„</label>
                    <input type="text" id="username-input" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 focus:outline-none focus:border-slam-red focus:ring-1 focus:ring-slam-red transition" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">ê·¼ë¬´ íƒ€ì„ ì„ íƒ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="shift" value="open" class="peer sr-only">
                            <div class="p-3 text-center rounded-xl border border-gray-200 peer-checked:bg-slam-red peer-checked:text-white peer-checked:border-slam-red transition hover:bg-gray-50 bg-white">
                                <span class="block font-bold text-sm">ì˜¤í”ˆ</span>
                                <span class="text-xs opacity-70">09:00~</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="shift" value="middle" class="peer sr-only">
                            <div class="p-3 text-center rounded-xl border border-gray-200 peer-checked:bg-slam-red peer-checked:text-white peer-checked:border-slam-red transition hover:bg-gray-50 bg-white">
                                <span class="block font-bold text-sm">ë¯¸ë“¤</span>
                                <span class="text-xs opacity-70">14:00~</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="shift" value="close" class="peer sr-only">
                            <div class="p-3 text-center rounded-xl border border-gray-200 peer-checked:bg-slam-red peer-checked:text-white peer-checked:border-slam-red transition hover:bg-gray-50 bg-white">
                                <span class="block font-bold text-sm">ë§ˆê°</span>
                                <span class="text-xs opacity-70">21:00~</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Gemini API Key</label>
                    <input type="password" id="apikey-input" class="w-full p-4 bg-gray-50 rounded-2xl border border-gray-200 focus:outline-none focus:border-slam-red focus:ring-1 focus:ring-slam-red transition" placeholder="AI ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì…ë ¥ (ì„ íƒ)">
                </div>
                
                <button onclick="handleLogin()" class="w-full py-4 bg-slam-red text-white font-bold rounded-2xl shadow-toss hover:bg-red-700 transition transform active:scale-95 mt-4">
                    ì¶œê·¼í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app-container" class="flex h-full hidden">
        
        <!-- Mobile Drawer -->
        <div id="mobile-drawer" class="fixed inset-0 z-40 bg-black/50 hidden transition-opacity" onclick="toggleDrawer()">
            <div class="absolute left-0 top-0 h-full w-64 bg-white shadow-xl p-6" onclick="event.stopPropagation()">
                <h2 class="text-2xl font-bold text-slam-red mb-8">MENU</h2>
                <nav class="space-y-4">
                    <button onclick="navigate('home'); toggleDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 font-medium">ğŸ  í™ˆ ëŒ€ì‹œë³´ë“œ</button>
                    <button onclick="navigate('checklist'); toggleDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 font-medium">âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
                    <button onclick="navigate('points'); toggleDrawer()" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 font-medium">ğŸ† í¬ì¸íŠ¸ & ë­í‚¹</button>
                    <button onclick="logout()" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 font-medium text-gray-400 mt-10">ë¡œê·¸ì•„ì›ƒ</button>
                </nav>
            </div>
        </div>

        <!-- PC Header -->
        <header class="fixed top-0 w-full bg-white/80 backdrop-blur-md z-30 border-b border-gray-100 h-16 flex items-center justify-between px-4 md:px-10">
            <div class="flex items-center gap-4">
                <button onclick="toggleDrawer()" class="md:hidden p-2">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <span class="text-xl font-bold text-slam-red cursor-pointer" onclick="navigate('home')">SLAM BURGER</span>
            </div>
            
            <nav class="hidden md:flex gap-8">
                <button onclick="navigate('home')" class="font-medium hover:text-slam-red transition">í™ˆ</button>
                <button onclick="navigate('checklist')" class="font-medium hover:text-slam-red transition">ì²´í¬ë¦¬ìŠ¤íŠ¸</button>
                <button onclick="navigate('points')" class="font-medium hover:text-slam-red transition">í¬ì¸íŠ¸ í˜„í™©</button>
            </nav>

            <div class="flex items-center gap-3">
                <div class="text-right hidden md:block">
                    <p class="text-xs text-gray-500" id="header-shift">Shift</p>
                    <p class="font-bold" id="header-username">Guest</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-slam-red text-white flex items-center justify-center font-bold">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 pt-20 pb-20 md:pb-6 px-4 md:px-10 overflow-y-auto w-full max-w-7xl mx-auto scroll-smooth">
            
            <!-- VIEW: HOME -->
            <div id="view-home" class="space-y-6 animate-fade-in">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-toss relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-full -mr-10 -mt-10 z-0"></div>
                    <div class="relative z-10">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">ë°˜ê°‘ìŠµë‹ˆë‹¤, <span class="text-slam-red" id="dashboard-name">í™ê¸¸ë™</span>ë‹˜!</h2>
                        <p class="text-gray-500 mb-6">ì˜¤ëŠ˜ <span id="dashboard-shift" class="font-bold text-slam-dark">ì˜¤í”ˆ</span> ê·¼ë¬´ë„ í˜ë‚´ì„¸ìš”.</p>
                        
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 bg-gray-50 rounded-2xl p-4 flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">ë‚´ ëˆ„ì  í¬ì¸íŠ¸</p>
                                    <p class="text-2xl font-bold text-slam-red" id="my-points-display">0 P</p>
                                </div>
                                <i data-lucide="award" class="w-8 h-8 text-yellow-500"></i>
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-2xl p-4 flex items-center justify-between cursor-pointer" onclick="navigate('checklist')">
                                <div>
                                    <p class="text-sm text-gray-500">ì§„í–‰ì¤‘ì¸ ì—…ë¬´</p>
                                    <p class="text-2xl font-bold" id="task-progress-display">0 / 0</p>
                                </div>
                                <i data-lucide="clipboard-list" class="w-8 h-8 text-blue-500"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="navigate('checklist')" class="bg-white p-6 rounded-3xl shadow-sm hover:shadow-toss transition text-left group">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition">
                            <i data-lucide="check-square" class="text-slam-red w-5 h-5"></i>
                        </div>
                        <h3 class="font-bold mb-1">ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                        <p class="text-xs text-gray-400">ì—…ë¬´ ìˆ˜í–‰ ë° ë³´ê³ </p>
                    </button>
                    <button onclick="navigate('points')" class="bg-white p-6 rounded-3xl shadow-sm hover:shadow-toss transition text-left group">
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition">
                            <i data-lucide="bar-chart-2" class="text-yellow-600 w-5 h-5"></i>
                        </div>
                        <h3 class="font-bold mb-1">í¬ì¸íŠ¸ í˜„í™©</h3>
                        <p class="text-xs text-gray-400">ëª…ì˜ˆì˜ ì „ë‹¹ í™•ì¸</p>
                    </button>
                     <button onclick="openChatbot()" class="bg-white p-6 rounded-3xl shadow-sm hover:shadow-toss transition text-left group">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition">
                            <i data-lucide="bot" class="text-blue-600 w-5 h-5"></i>
                        </div>
                        <h3 class="font-bold mb-1">AI ë§¤ë‰´ì–¼</h3>
                        <p class="text-xs text-gray-400">ë ˆì‹œí”¼ & ê·œì • ì§ˆë¬¸</p>
                    </button>
                </div>
            </div>

            <!-- VIEW: CHECKLIST -->
            <div id="view-checklist" class="hidden space-y-6">
                <div class="flex justify-between items-center sticky top-0 bg-slam-gray py-2 z-10 backdrop-blur-sm">
                    <div>
                        <h2 class="text-2xl font-bold">âœ… ì—…ë¬´ ë¦¬ìŠ¤íŠ¸</h2>
                        <p class="text-sm text-gray-500" id="checklist-subtitle">ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì—…ë¬´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                    <div class="bg-white px-3 py-1 rounded-lg border border-gray-200 text-sm font-bold text-slam-red">
                        <span id="current-shift-display">OPEN</span>
                    </div>
                </div>

                <!-- Checklist Container -->
                <div id="checklist-items" class="space-y-6 pb-20">
                    <!-- Dynamic Injection -->
                </div>

                <div class="fixed bottom-6 left-0 w-full px-4 md:px-10 z-20 pointer-events-none">
                     <button onclick="submitChecklist()" id="submit-btn" class="pointer-events-auto w-full max-w-7xl mx-auto py-4 bg-slam-red text-white font-bold rounded-2xl shadow-floating hover:bg-red-700 transition active:scale-95 flex justify-center items-center gap-2">
                        <span>ë³´ê³  ì™„ë£Œí•˜ê³  í¬ì¸íŠ¸ ë°›ê¸°</span>
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW: POINTS -->
            <div id="view-points" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">ğŸ† í¬ì¸íŠ¸ í˜„í™©</h2>
                <div class="bg-white p-6 rounded-3xl shadow-toss min-h-[300px]">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">ì‹¤ì‹œê°„ ë­í‚¹</h3>
                        <button onclick="fetchRanking()" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div id="ranking-list" class="space-y-4">
                        <div class="text-center py-10 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Chatbot Components -->
    <button onclick="toggleChatbot()" class="fixed bottom-24 md:bottom-6 right-6 w-14 h-14 bg-slam-dark text-white rounded-full shadow-floating flex items-center justify-center hover:scale-105 transition z-40 hidden md:flex">
        <i data-lucide="message-circle" class="w-6 h-6"></i>
    </button>

    <div id="chatbot-panel" class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-white shadow-2xl z-50 slide-in-right flex flex-col border-l border-gray-200">
        <div class="p-4 border-b flex justify-between items-center bg-slam-dark text-white">
            <div class="flex items-center gap-2">
                <i data-lucide="bot" class="w-5 h-5 text-slam-red"></i>
                <span class="font-bold">Slam Burger AI</span>
            </div>
            <button onclick="toggleChatbot()" class="p-1 hover:bg-gray-700 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <div class="flex gap-3">
                <div class="w-8 h-8 bg-slam-red rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100">
                    ì•ˆë…•í•˜ì„¸ìš”! ë§¤ì¥ ìš´ì˜ ì¤‘ ê¶ê¸ˆí•œ ì ì´ë‚˜ ë ˆì‹œí”¼ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”.
                </div>
            </div>
        </div>
        <div class="p-4 bg-white border-t flex gap-2">
            <input type="text" id="chat-input" class="flex-1 bg-gray-100 border-0 rounded-xl px-4 py-3 text-sm" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" class="bg-slam-red text-white p-3 rounded-xl hover:bg-red-700 transition"><i data-lucide="send" class="w-4 h-4"></i></button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[60] bg-black/60 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative animate-fade-in">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-black"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h3 id="modal-title" class="text-xl font-bold mb-4 border-b pb-2">ìƒì„¸ ê°€ì´ë“œ</h3>
            <div id="modal-content" class="text-sm text-gray-600 leading-relaxed space-y-4"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal()" class="px-5 py-2 bg-gray-100 rounded-xl text-sm font-bold hover:bg-gray-200">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // â˜… ì œê³µëœ GAS Web App URL ì ìš© â˜…
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzy5SUszrtjSrglx_dBkWHAi6C2yH_Vvw1fSlOgTBDMYaFDDplRs9IGNsI620OSIbqX/exec"; 

        // --- Real Data Structure (From CSV Analysis) ---
        const realChecklistData = {
            open: [
                {
                    category: "ì¶œê·¼ ë° ë³µì¥ ì ê²€ (09:00)",
                    items: [
                        { id: "o1", task: "ë³µì¥ ì ê²€ (ìœ ë‹ˆí¼, ëª¨ì, ëª…ì°°)", desc: "ë‹¨ì •í•œ ë³µì¥, ë¨¸ë¦¬ì¹´ë½ ë…¸ì¶œ ê¸ˆì§€, ëª…ì°° íŒ¨ìš© í•„ìˆ˜.", points: 5 },
                        { id: "o2", task: "ì† ì„¸ì²™ (30ì´ˆ)", desc: "30ì´ˆ ì´ìƒ íë¥´ëŠ” ë¬¼ì— ì† ì„¸ì²™ í›„ ì†Œë…ì ¤ ì‚¬ìš©.", points: 5 },
                        { id: "o3", task: "ì—…ë¬´ ê³µìœ  ì‚¬í•­ í™•ì¸ (ì”ë””)", desc: "ì „ë‚  ë§ˆê° ì „ë‹¬ì‚¬í•­ ë° ë³¸ì‚¬ ê³µì§€ì‚¬í•­ í™•ì¸.", points: 5 }
                    ]
                },
                {
                    category: "ë§¤ì¥ ì˜¤í”ˆ ì¤€ë¹„",
                    items: [
                        { id: "o4", task: "ë§¤ì¥ ì „ì²´ í™˜ê¸° ë° ì¡°ëª… ON", desc: "ì¶œì…ë¬¸ ê°œë°© 10ë¶„, í™€/ì£¼ë°©/ê°„íŒ ì¡°ëª… ì ë“±.", points: 10 },
                        { id: "o5", task: "POS ë° í‚¤ì˜¤ìŠ¤í¬/DID ë¶€íŒ…", desc: "ì „ì› ON í›„ ì •ìƒ ì‘ë™ í™•ì¸. ì¤€ë¹„ê¸ˆ í™•ì¸.", points: 10 },
                        { id: "o6", task: "ì—ì–´ì»¨ ë° ìŒì•…(BGM) ê°€ë™", desc: "ì ì • ì˜¨ë„ ì„¤ì • ë° ë§¤ì¥ ë¶„ìœ„ê¸°ì— ë§ëŠ” ìŒì•… ì¬ìƒ.", points: 5 }
                    ]
                },
                {
                    category: "ì£¼ë°© ê¸°ê¸° ë° ì‹ìì¬ ì ê²€",
                    items: [
                        { id: "o7", task: "íŠ€ê¹€ê¸° ì˜ˆì—´ ë° ê¸°ë¦„ ìƒíƒœ í™•ì¸", desc: "170ë„ ì˜ˆì—´, ì‚°íŒ¨ë„ ì¸¡ì • (2.5 ì´ìƒ ì‹œ êµì²´ ë³´ê³ ).", points: 15 },
                        { id: "o8", task: "ëƒ‰ì¥/ëƒ‰ë™ê³  ì˜¨ë„ ì²´í¬", desc: "ëƒ‰ì¥ 5ë„ ì´í•˜, ëƒ‰ë™ -18ë„ ì´í•˜ í™•ì¸.", points: 10 },
                        { id: "o9", task: "ì‹ì¬ë£Œ ê²€ìˆ˜ ë° ì„ ì…ì„ ì¶œ ì •ë¦¬", desc: "ì…ê³  ì‹ìì¬ ê²€ìˆ˜, ìœ í†µê¸°í•œ í™•ì¸í•˜ì—¬ ì •ë¦¬.", points: 15 },
                        { id: "o10", task: "ì˜¤í”ˆ ì¤€ë¹„ ì¬ë£Œ ì„¸íŒ…", desc: "í–„ë²„ê±° ë²ˆ, íŒ¨í‹°(ì†Œ/ì¹˜í‚¨/ê°ˆë¹„), ì•¼ì±„, ì†ŒìŠ¤ë¥˜ í•„ì—….", points: 20 }
                    ]
                }
            ],
            middle: [
                {
                    category: "í”¼í¬íƒ€ì„ ëŒ€ë¹„ ë° í™˜ê²½ì •ë¹„ (14:00~)",
                    items: [
                        { id: "m1", task: "ì”ì—¬ ì‹ì¬ë£Œ ë³´ê´€ ìƒíƒœ í™•ì¸", desc: "ì‚¬ìš© ì¤‘ì¸ ì‹ì¬ë£Œ ëšœê»‘ ë‹«ê¸°(ì´ë¬¼ì§ˆ ë°©ì§€).", points: 10 },
                        { id: "m2", task: "ì¡°ë¦¬ ë„êµ¬ ì„¸ì²™ ë° ì¬ì„¸íŒ…", desc: "ì˜¤ì „ ì‚¬ìš©í•œ ë„êµ¬ ì„¸ì²™ ë° ì†Œë….", points: 10 },
                        { id: "m3", task: "í™€ í…Œì´ë¸” ë° ë°”ë‹¥ ì²­ê²° ì ê²€", desc: "ì ì‹¬ í”¼í¬ ì´í›„ í™€ ë°”ë‹¥ ì“¸ê¸° ë° í…Œì´ë¸” ì†Œë….", points: 15 }
                    ]
                },
                {
                    category: "ì¬ê³  íŒŒì•… ë° ë°œì£¼ ì¤€ë¹„",
                    items: [
                        { id: "m4", task: "ì‹ì¬ë£Œ/ë¶€ìì¬ ì¬ê³  í™•ì¸", desc: "ë¶€ì¡±í•œ í’ˆëª© íŒŒì•… (ë²„ê±°ë²ˆ, íŒ¨í‹°, í¬ì¥ì§€ ë“±).", points: 15 },
                        { id: "m5", task: "ë°œì£¼ì„œ ì‘ì„± (15ì‹œ ë§ˆê°)", desc: "ì „ìš© ì‹œíŠ¸ì— ë°œì£¼ ìˆ˜ëŸ‰ ê¸°ì… ë° ì”ë”” ê³µìœ .", points: 20 },
                        { id: "m6", task: "ê³ ê° í”¼ë“œë°±/ë¦¬ë·° í™•ì¸", desc: "ìµœê·¼ 2ì¼ê°„ ê³ ê° ë¦¬ë·° í™•ì¸ ë° ê³µìœ .", points: 10 }
                    ]
                },
                {
                    category: "ì €ë… ì˜ì—… ì¤€ë¹„",
                    items: [
                        { id: "m7", task: "ì €ë…ìš© ì‹ì¬ë£Œ ì¶”ê°€ í•´ë™/ì„¸íŒ…", desc: "í’€ë“œí¬í¬, ë³¶ìŒë°¥ ë“± ì €ë… ë©”ë‰´ ì¬ë£Œ ì¤€ë¹„.", points: 15 },
                        { id: "m8", task: "ì†ŒìŠ¤ ë° ì‹œì¦ˆë‹ ë¦¬í•„", desc: "ì†ŒìŠ¤í†µ 80% ì´ìƒ ì±„ìš°ê¸°.", points: 10 }
                    ]
                }
            ],
            close: [
                {
                    category: "ì£¼ë°© ë§ˆê° ë° ì²­ì†Œ (21:00~)",
                    items: [
                        { id: "c1", task: "íŠ€ê¹€ê¸° ê¸°ë¦„ ì •ì œ/êµì²´", desc: "ê¸°ë¦„ ì‹íŒ í›„ ì •ì œê¸° ì‚¬ìš©. (ì£¼2íšŒ ì •ì œ, ì£¼1íšŒ êµì²´ ì¤€ìˆ˜)", points: 30 },
                        { id: "c2", task: "ê·¸ë¦´íŒ íƒ„í™”ë¬¼ ì œê±°(ìŠ¤í¬ë˜í¼)", desc: "ì „ìš© ì„¸ì œ ì‚¬ìš©, ë¬¼ê¸° ì œê±° í›„ ì½”íŒ….", points: 25 },
                        { id: "c3", task: "í›„ë“œ í•„í„° ë° íŠ¸ëœì¹˜ ì²­ì†Œ", desc: "í•„í„° ë¶„ë¦¬ ì„¸ì²™, ë°”ë‹¥ í•˜ìˆ˜êµ¬ ê±°ë¦„ë§ ë¹„ìš°ê¸°.", points: 20 },
                        { id: "c4", task: "ì‹±í¬ëŒ€ ë° í–‰ì£¼ ë§ˆê°", desc: "ì‹±í¬ëŒ€ ë¬¼ê¸° ì œê±°, í–‰ì£¼ ì‚´ê·  ì†Œë….", points: 15 }
                    ]
                },
                {
                    category: "ì‹ìì¬ ë§ˆê°",
                    items: [
                        { id: "c5", task: "ë‚¨ì€ ì‹ìì¬ ë°€ë´‰/ë¼ë²¨ë§", desc: "ê°œë´‰í•œ ì‹ìì¬ ë°€ë´‰ í›„ ë‚ ì§œ ê¸°ì….", points: 15 },
                        { id: "c6", task: "ìŒì‹ë¬¼ ì“°ë ˆê¸° ì²˜ë¦¬", desc: "ì§€ì •ëœ ì¥ì†Œì— ë°°ì¶œ.", points: 10 }
                    ]
                },
                {
                    category: "ë§¤ì¥ ë³´ì•ˆ ë° ì†Œë“±",
                    items: [
                        { id: "c7", task: "ê°€ìŠ¤ ë°¸ë¸Œ ì°¨ë‹¨ í™•ì¸", desc: "ë©”ì¸ ê°€ìŠ¤ ë°¸ë¸Œ ì ê¸ˆ í•„ìˆ˜.", points: 10 },
                        { id: "c8", task: "ì „ìê¸°ê¸° ì „ì› OFF", desc: "POS ë§ˆê° ì •ì‚°, ì˜¤ë””ì˜¤, ì¡°ëª…, ì—ì–´ì»¨ ì°¨ë‹¨.", points: 10 },
                        { id: "c9", task: "ìµœì¢… ë¬¸ ë‹¨ì†", desc: "ì°½ë¬¸ ë° ì¶œì…ë¬¸ ì ê¸ˆ ìƒíƒœ í™•ì¸.", points: 10 }
                    ]
                }
            ]
        };

        // --- State ---
        const state = {
            user: null,
            shift: null,
            apiKey: null,
            points: 0,
            currentView: 'home'
        };

        // --- Init ---
        window.onload = () => {
            lucide.createIcons();
            
            const storedUser = localStorage.getItem('slam_user');
            const storedShift = localStorage.getItem('slam_shift');
            const storedKey = localStorage.getItem('slam_apikey');

            if (storedUser && storedShift) {
                state.user = storedUser;
                state.shift = storedShift;
                state.apiKey = storedKey;
                
                // Set Inputs for re-login convenience
                document.getElementById('username-input').value = storedUser;
                const radios = document.getElementsByName('shift');
                radios.forEach(r => { if(r.value === storedShift) r.checked = true; });

                enterApp(false);
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        function handleLogin() {
            const user = document.getElementById('username-input').value.trim();
            const apiKey = document.getElementById('apikey-input').value.trim();
            
            let selectedShift = null;
            const radios = document.getElementsByName('shift');
            for(let r of radios) { if(r.checked) selectedShift = r.value; }

            if (!user) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            if (!selectedShift) return alert('ê·¼ë¬´ íƒ€ì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            localStorage.setItem('slam_user', user);
            localStorage.setItem('slam_shift', selectedShift);
            if(apiKey) localStorage.setItem('slam_apikey', apiKey);

            state.user = user;
            state.shift = selectedShift;
            state.apiKey = apiKey;

            enterApp(true);
        }

        function enterApp(isFirstLogin) {
            const loginScreen = document.getElementById('login-screen');
            loginScreen.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                loginScreen.style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
            }, 300);

            document.getElementById('header-username').innerText = state.user;
            document.getElementById('dashboard-name').innerText = state.user;
            document.getElementById('header-shift').innerText = state.shift.toUpperCase();
            
            const shiftMap = { 'open': 'ì˜¤í”ˆ', 'middle': 'ë¯¸ë“¤', 'close': 'ë§ˆê°' };
            document.getElementById('dashboard-shift').innerText = shiftMap[state.shift];
            document.getElementById('current-shift-display').innerText = shiftMap[state.shift];

            fetchUserPoints(); 
            navigate('home');
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function navigate(viewId) {
            ['home', 'checklist', 'points'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            if (viewId === 'checklist') loadChecklist();
            if (viewId === 'points') fetchRanking();

            document.getElementById('mobile-drawer').classList.add('hidden');
        }

        function toggleDrawer() {
            const drawer = document.getElementById('mobile-drawer');
            drawer.classList.toggle('hidden');
        }

        // --- Checklist Logic ---
        function loadChecklist() {
            // Use logged-in shift instead of dropdown
            const timeSlot = state.shift;
            const categoryList = realChecklistData[timeSlot];
            const container = document.getElementById('checklist-items');
            
            container.innerHTML = ''; 

            let totalTasks = 0;
            let completedTasks = 0; // In a real app, fetch checked status from DB

            categoryList.forEach(category => {
                const catHeader = document.createElement('div');
                catHeader.className = "flex items-center gap-2 pt-4 pb-2 border-b border-gray-200 mt-2 first:mt-0";
                catHeader.innerHTML = `<h3 class="font-bold text-gray-700 text-lg">${category.category}</h3>`;
                container.appendChild(catHeader);

                category.items.forEach(item => {
                    totalTasks++;
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 transition hover:shadow-md';
                    el.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="check-${item.id}" data-points="${item.points}" class="w-6 h-6 text-slam-red rounded focus:ring-slam-red border-gray-300 cursor-pointer task-checkbox" onchange="toggleTaskStyle(this)">
                                <div>
                                    <label for="check-${item.id}" class="font-bold text-base cursor-pointer select-none">${item.task}</label>
                                    <p class="text-xs text-slam-red font-medium">+${item.points} P</p>
                                </div>
                            </div>
                            <button onclick="showDetail('${item.id}', '${timeSlot}')" class="text-gray-400 hover:text-slam-red p-1">
                                <i data-lucide="help-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="pl-9 hidden" id="photo-${item.id}">
                            <label class="cursor-pointer flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-xs text-gray-500 hover:bg-gray-100 border border-gray-200 w-fit">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>ì¸ì¦ ì‚¬ì§„ ì²¨ë¶€</span>
                                <input type="file" class="hidden" accept="image/*" onchange="alert('ì‚¬ì§„ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.')">
                            </label>
                        </div>
                    `;
                    container.appendChild(el);
                });
            });
            lucide.createIcons();
            document.getElementById('task-progress-display').innerText = `0 / ${totalTasks}`;
        }

        function toggleTaskStyle(checkbox) {
            const label = checkbox.nextElementSibling.querySelector('label');
            const photoArea = document.getElementById(`photo-${checkbox.id.replace('check-', '')}`);
            
            if (checkbox.checked) {
                label.classList.add('text-gray-400', 'line-through');
                photoArea.classList.remove('hidden');
            } else {
                label.classList.remove('text-gray-400', 'line-through');
                photoArea.classList.add('hidden');
            }
        }

        function showDetail(id, timeSlot) {
            let item;
            realChecklistData[timeSlot].forEach(cat => {
                const found = cat.items.find(i => i.id === id);
                if(found) item = found;
            });
            if(!item) return;

            document.getElementById('modal-title').innerText = item.task;
            document.getElementById('modal-content').innerHTML = `
                <p class="text-lg font-bold text-gray-800 mb-2">ì—…ë¬´ ê°€ì´ë“œ</p>
                <p>${item.desc}</p>
                <div class="mt-4 p-3 bg-red-50 text-slam-red rounded-lg text-xs font-bold">
                    ğŸ’¡ ê¼¼ê¼¼íˆ í™•ì¸ í›„ ì²´í¬í•´ì£¼ì„¸ìš”!
                </div>
            `;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
        }

        // --- Network Logic ---

        function fetchUserPoints() {
            document.getElementById('my-points-display').innerText = '...';
            // GET request with user param
            fetch(`${GAS_WEB_APP_URL}?type=user_info&user=${encodeURIComponent(state.user)}`)
            .then(res => res.json())
            .then(data => {
                state.points = data.points || 0;
                document.getElementById('my-points-display').innerText = `${state.points.toLocaleString()} P`;
            })
            .catch(err => {
                console.error("Offline or Error:", err);
                document.getElementById('my-points-display').innerText = `${state.points} P`;
            });
        }

        function submitChecklist() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ì™„ë£Œí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let earnedPoints = 0;
            let tasksCompleted = [];

            checkboxes.forEach(cb => {
                earnedPoints += parseInt(cb.getAttribute('data-points'));
                const taskName = cb.nextElementSibling.querySelector('label').innerText;
                tasksCompleted.push(taskName);
            });

            if(!confirm(`ì´ ${checkboxes.length}ê°œ í•­ëª©ì„ ì™„ë£Œ ë³´ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜ˆìƒ ì ë¦½ í¬ì¸íŠ¸: ${earnedPoints} P`)) return;

            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ë³´ê³  ì „ì†¡ì¤‘...';
            btn.disabled = true;

            const payload = {
                type: 'checklist_report',
                user: state.user,
                points: earnedPoints,
                shift: state.shift,
                tasks: tasksCompleted.join(', '),
                timestamp: new Date().toISOString()
            };

            // Send POST (no-cors)
            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // text/plain avoids preflight in some cases
                body: JSON.stringify(payload)
            }).then(() => {
                alert(`âœ… ë³´ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n${earnedPoints} í¬ì¸íŠ¸ê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // Optimistic Update
                state.points += earnedPoints;
                document.getElementById('my-points-display').innerText = `${state.points.toLocaleString()} P`;
                
                // Reset UI
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    toggleTaskStyle(cb);
                });
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Refresh Server Data
                setTimeout(fetchUserPoints, 2000);

            }).catch(err => {
                alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function fetchRanking() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '<div class="text-center py-4">ë­í‚¹ ë¡œë”©ì¤‘...</div>';

            fetch(`${GAS_WEB_APP_URL}?type=ranking`)
            .then(res => res.json())
            .then(data => {
                list.innerHTML = '';
                if(data.length === 0) {
                     list.innerHTML = '<div class="text-center py-4 text-gray-400">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                     return;
                }
                data.forEach((u, idx) => {
                    const isMe = u.name === state.user;
                    const rankColor = idx === 0 ? 'bg-yellow-400' : (idx === 1 ? 'bg-gray-300' : (idx === 2 ? 'bg-orange-400' : 'bg-gray-100 text-gray-500'));
                    
                    const row = document.createElement('div');
                    row.className = `flex items-center justify-between border-b pb-4 ${isMe ? 'bg-red-50 p-2 rounded-lg border-none' : ''}`;
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 ${rankColor} rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${idx + 1}
                            </div>
                            <span class="font-medium ${isMe ? 'text-slam-red font-bold' : ''}">${u.name}</span>
                        </div>
                        <span class="font-bold text-gray-700">${parseInt(u.points).toLocaleString()} P</span>
                    `;
                    list.appendChild(row);
                });
            })
            .catch(err => {
                list.innerHTML = '<div class="text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        // --- Chatbot ---
        function toggleChatbot() { document.getElementById('chatbot-panel').classList.toggle('active'); }
        function openChatbot() { document.getElementById('chatbot-panel').classList.add('active'); }
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            appendMessage('user', message);
            input.value = '';
            const loadingId = 'loading-' + Date.now();
            appendMessage('bot', '<span id="'+loadingId+'">ë‹µë³€ì„ ìƒì„±ì¤‘ì…ë‹ˆë‹¤...</span>');
            try {
                const response = await fetchGemini(message);
                document.getElementById(loadingId).parentElement.innerHTML = response;
            } catch (error) {
                document.getElementById(loadingId).innerText = "API í‚¤ ì˜¤ë¥˜ í˜¹ì€ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì…ë‹ˆë‹¤.";
            }
        }
        function appendMessage(sender, html) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex gap-3 mb-4 animate-fade-in';
            if (sender === 'user') {
                div.classList.add('flex-row-reverse');
                div.innerHTML = `<div class="bg-slam-red text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[80%]">${html}</div>`;
            } else {
                div.innerHTML = `<div class="w-8 h-8 bg-slam-red rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 max-w-[85%] leading-relaxed">${html}</div>`;
            }
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }
        async function fetchGemini(prompt) {
            if (!state.apiKey) throw new Error("No API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`;
            const systemContext = `ë‹¹ì‹ ì€ 'ìŠ¬ë¨ë²„ê±°' ë§¤ì¥ ë§¤ë‹ˆì € AIì…ë‹ˆë‹¤. ì§ˆë¬¸ìê°€ ê·¼ë¬´ìë¼ê³  ê°€ì •í•˜ê³ , ë§¤ë‰´ì–¼ì— ê¸°ë°˜í•˜ì—¬ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.`;
            const payload = { contents: [{ parts: [{ text: systemContext + "\nUser: " + prompt }] }] };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
