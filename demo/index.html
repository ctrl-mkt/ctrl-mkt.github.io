<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie - AI F&B Management Platform</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Pretendard', 'sans-serif'] },
                    colors: {
                        navy: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        blue: { 500: '#3b82f6', 400: '#60a5fa', 100: '#dbeafe' },
                        lightblue: { 500: '#0ea5e9' }
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased overflow-hidden h-screen flex flex-col">

    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-navy-900 to-blue-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all hover:scale-105 duration-300">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-navy-900 tracking-tight">RestoGenie</h1>
                <p class="text-slate-500 mt-2">AI-Powered F&B Management</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ID</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="demo" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ctrlm2025!" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:-translate-y-1">Login</button>
            </form>
            <p class="text-xs text-center text-slate-400 mt-6">RestoGenie v2.6 (Live)</p>
        </div>
    </div>

    <!-- ==================== ROLE SELECTION SCREEN ==================== -->
    <div id="role-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-slate-100 hidden">
        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8 p-8">
            <div onclick="selectRole('HQ')" class="bg-white p-8 rounded-2xl shadow-xl cursor-pointer hover:shadow-2xl hover:border-blue-500 border-2 border-transparent transition-all group">
                <div class="flex justify-center mb-6">
                    <div class="p-4 bg-blue-100 rounded-full group-hover:bg-blue-200 transition"><i class="ph ph-buildings text-4xl text-blue-600"></i></div>
                </div>
                <h2 class="text-2xl font-bold text-center text-navy-900 mb-2">ê°€ë§¹ë³¸ì‚¬ (HQ)</h2>
                <p class="text-slate-500 text-center">ì „ì‚¬ í†µí•© ê´€ë¦¬, ë¸Œëœë“œ í‘œì¤€í™”</p>
            </div>
            <div onclick="selectRole('Partner')" class="bg-white p-8 rounded-2xl shadow-xl cursor-pointer hover:shadow-2xl hover:border-lightblue-500 border-2 border-transparent transition-all group">
                <div class="flex justify-center mb-6">
                    <div class="p-4 bg-lightblue-100 rounded-full group-hover:bg-lightblue-200 transition"><i class="ph ph-storefront text-4xl text-lightblue-600"></i></div>
                </div>
                <h2 class="text-2xl font-bold text-center text-navy-900 mb-2">ê°€ë§¹ì ì£¼ (Partner)</h2>
                <p class="text-slate-500 text-center">ë§¤ì¥ ìš´ì˜ íš¨ìœ¨í™”, ìˆ˜ìµì„± ë¶„ì„</p>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP LAYOUT ==================== -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        <aside class="w-64 bg-navy-900 text-white flex flex-col shadow-lg z-30 transition-all duration-300" id="sidebar">
            <div class="p-6 flex items-center justify-between cursor-pointer" onclick="renderPage(CURRENT_ROLE === 'HQ' ? 'dashboard' : 'home')">
                <div class="flex items-center space-x-2">
                    <i class="ph ph-robot text-2xl text-blue-400"></i>
                    <span class="text-xl font-bold tracking-wide">RestoGenie</span>
                </div>
            </div>
            <div class="px-6 pb-4">
                <div class="bg-navy-800 rounded-lg px-3 py-2 text-xs text-blue-200 flex items-center justify-between">
                    <span id="current-role-display">HQ Mode</span>
                    <button onclick="logout()" class="hover:text-white"><i class="ph ph-sign-out"></i></button>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto px-3 space-y-1" id="menu-container"></nav>
            <div class="p-4 bg-navy-800 text-xs text-slate-400">
                <div class="flex justify-between items-center mb-2">
                    <span>Genie Coins</span>
                    <span id="coin-balance" class="text-yellow-400 font-bold">100 C</span>
                </div>
                <button onclick="rechargeCoins()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded flex items-center justify-center gap-2">
                    <i class="ph ph-lightning"></i> ë¬´ë£Œ ì¶©ì „ (ê´‘ê³ )
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-20">
                <div class="flex items-center">
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="store-selector-wrapper" class="hidden">
                        <select id="store-selector" class="bg-slate-100 border-none text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" onchange="handleStoreChange()">
                            <option value="all">ì „ì²´ ë§¤ì¥ (All Stores)</option>
                            <option value="gangnam">ìŠ¬ë¨ë²„ê±° ê°•ë‚¨ì </option>
                            <option value="daehakro">ìŠ¬ë¨ë²„ê±° ëŒ€í•™ë¡œì </option>
                        </select>
                    </div>
                    <div class="flex bg-slate-100 rounded-lg p-1">
                        <button onclick="setDateFilter('day')" class="date-filter-btn px-3 py-1 rounded-md text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition" data-period="day">ì¼</button>
                        <button onclick="setDateFilter('week')" class="date-filter-btn px-3 py-1 rounded-md text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition" data-period="week">ì£¼</button>
                        <button onclick="setDateFilter('month')" class="date-filter-btn px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm text-blue-600 transition" data-period="month">ì›”</button>
                    </div>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-6 space-y-6 relative"></div>
            
            <div class="absolute bottom-6 right-6 z-50">
                <button onclick="toggleChatbot()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform flex items-center justify-center">
                    <i class="ph ph-sparkle text-2xl"></i>
                </button>
            </div>

            <div id="chatbot-modal" class="hidden absolute bottom-20 right-6 w-96 h-[600px] bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col z-50 overflow-hidden">
                <div class="bg-navy-900 p-4 flex justify-between items-center text-white">
                    <div class="flex items-center gap-2"><i class="ph ph-robot"></i><span class="font-bold">RestoGenie AI</span></div>
                    <button onclick="toggleChatbot()" class="hover:text-gray-300"><i class="ph ph-x"></i></button>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                    <div class="flex gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 text-blue-600"><i class="ph ph-robot"></i></div>
                        <div class="bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm text-sm text-slate-700 border border-slate-100">ì•ˆë…•í•˜ì„¸ìš”! ë ˆìŠ¤í† ì§€ë‹ˆ AIì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
                    </div>
                </div>
                <div class="p-3 bg-white border-t border-slate-100">
                    <div class="flex items-center bg-slate-100 rounded-full px-4 py-2">
                        <input type="text" id="chat-input" class="bg-transparent flex-1 outline-none text-sm" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="handleChatKey(event)">
                        <button onclick="sendChat()" class="text-blue-600 hover:text-blue-800 ml-2"><i class="ph ph-paper-plane-right"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ================= CONFIG & STATE =================
        const GEMINI_API_KEY = "AIzaSyCILSrQKjRiupRcyNd1pFJUksNMkGVY8AQ"; 
        let CURRENT_ROLE = null;
        let COINS = parseInt(localStorage.getItem('restogenie_coins')) || 100;
        let CURRENT_STORE = 'all';
        let CURRENT_PERIOD = 'month'; // 'day', 'week', 'month'
        let CURRENT_PAGE_ID = 'dashboard';

        // Mock Data Generators based on Filter
        const getFactor = () => CURRENT_PERIOD === 'day' ? 1 : (CURRENT_PERIOD === 'week' ? 7 : 30);
        const fmtMoney = (n) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(n);

        // ================= CORE FUNCTIONS =================
        function init() {
            updateCoinDisplay();
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if(document.getElementById('username').value === 'demo') {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('role-screen').classList.remove('hidden');
                    document.getElementById('role-screen').classList.add('flex');
                } else alert('ID: demo / PW: ctrlm2025!');
            });
        }
        init();

        function selectRole(role) {
            CURRENT_ROLE = role;
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('current-role-display').innerText = role === 'HQ' ? 'ê°€ë§¹ë³¸ì‚¬ (HQ)' : 'ê°€ë§¹ì ì£¼ (Partner)';
            document.getElementById('store-selector-wrapper').classList.toggle('hidden', role !== 'HQ');
            if (role === 'Partner') CURRENT_STORE = 'gangnam'; 
            renderSidebar();
            renderPage(role === 'HQ' ? 'dashboard' : 'home');
        }

        function logout() { location.reload(); }

        // ================= NAVIGATION =================
        const MENUS = {
            HQ: [
                { id: 'dashboard', icon: 'ph-chart-pie-slice', label: 'HQ ì¢…í•© ëŒ€ì‹œë³´ë“œ', sub: [] },
                { id: 'marketing', icon: 'ph-megaphone', label: 'ë§ˆì¼€íŒ… í˜„í™©', sub: [] },
                { id: 'commercial', icon: 'ph-map-pin', label: 'ìƒê¶Œ ë¶„ì„ (CCTV)', sub: [] },
                { id: 'store_mgmt', icon: 'ph-store-front', label: 'ë§¤ì¥ ìš´ì˜ ê´€ë¦¬', sub: [] },
                { id: 'menu_cost', icon: 'ph-hamburger', label: 'ë©”ë‰´/ì›ê°€ í˜„í™©', sub: [] },
                { id: 'ai_center', icon: 'ph-brain', label: 'AI ë¦¬í¬íŠ¸ ì„¼í„°', sub: [] }
            ],
            Partner: [
                { id: 'home', icon: 'ph-house', label: 'í™ˆ (Home)', sub: [] },
                { id: 'performance', icon: 'ph-chart-line-up', label: 'ì„±ê³¼ ë¶„ì„', sub: [] },
                { id: 'automation', icon: 'ph-gear', label: 'ìë™í™”/ì„¤ì •', sub: [] }
            ]
        };

        function renderSidebar() {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            MENUS[CURRENT_ROLE].forEach(item => {
                const div = document.createElement('div');
                div.onclick = () => renderPage(item.id);
                div.className = 'flex items-center px-3 py-3 text-slate-300 hover:bg-navy-800 hover:text-white rounded-lg cursor-pointer transition-colors mb-1';
                div.innerHTML = `<i class="ph ${item.icon} text-lg mr-3"></i><span class="font-medium">${item.label}</span>`;
                container.appendChild(div);
            });
        }

        function renderPage(pageId) {
            CURRENT_PAGE_ID = pageId;
            const content = document.getElementById('content-area');
            document.getElementById('page-title').innerText = MENUS[CURRENT_ROLE].find(m => m.id === pageId)?.label || pageId;
            content.innerHTML = '';

            // Routing
            if (pageId === 'dashboard' || pageId === 'home') renderDashboard(content);
            else if (pageId === 'ai_center') renderAIReportCenter(content);
            else if (pageId === 'commercial') renderCCTV(content);
            else if (pageId === 'marketing') renderMarketing(content);
            else if (pageId === 'store_mgmt') renderStoreMgmt(content);
            else if (pageId === 'menu_cost') renderMenuCost(content);
            else if (pageId === 'performance') renderPerformance(content);
            else if (pageId === 'automation') renderAutomation(content);
        }

        function setDateFilter(period) {
            CURRENT_PERIOD = period;
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                const active = btn.dataset.period === period;
                btn.className = `date-filter-btn px-3 py-1 rounded-md text-sm font-medium transition ${active ? 'bg-white shadow-sm text-blue-600' : 'text-slate-600 hover:bg-white'}`;
            });
            renderPage(CURRENT_PAGE_ID); // Re-render current page with new period data
        }

        // ================= PAGE RENDERERS (LIVE) =================

        // 1. Dashboard (HQ & Partner)
        function renderDashboard(container) {
            const f = getFactor();
            const sales = (CURRENT_STORE === 'all' ? 8500000 : 4200000) * f;
            const orders = (CURRENT_STORE === 'all' ? 320 : 150) * f;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    ${createCard('ì´ ë§¤ì¶œ', fmtMoney(sales), '+12.5%', 'ph-currency-krw', 'text-blue-600')}
                    ${createCard('ì£¼ë¬¸ìˆ˜', `${orders}ê±´`, '+5.3%', 'ph-receipt', 'text-purple-600')}
                    ${createCard('ê°ë‹¨ê°€', '15,200ì›', '-2.1%', 'ph-users-three', 'text-orange-500')}
                    ${createCard('ë°°ë‹¬ ë¹„ì¤‘', '45%', '+15%p', 'ph-moped', 'text-green-600')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ë§¤ì¶œ ì¶”ì´ (${CURRENT_PERIOD})</h3>
                        <canvas id="mainChart" height="250"></canvas>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-xl border border-blue-100">
                        <h3 class="font-bold text-indigo-900 mb-4 flex items-center"><i class="ph ph-sparkle mr-2"></i>AI Insight</h3>
                        <ul class="space-y-3 text-sm">
                            <li class="bg-white p-3 rounded shadow-sm border-l-4 border-red-400">
                                <span class="text-red-500 font-bold block">âš  ê°•ë‚¨ì  ìˆ˜ìµì„± ê²½ê³ </span>
                                ì¿ íŒ¡ì´ì¸  ë§¤ì¶œ 300% ê¸‰ì¦í–ˆìœ¼ë‚˜ ê°ë‹¨ê°€ í•˜ë½ ì‹¬ê°. í”„ë¡œëª¨ì…˜ ì¡°ì • í•„ìš”.
                            </li>
                            <li class="bg-white p-3 rounded shadow-sm border-l-4 border-green-400">
                                <span class="text-green-600 font-bold block">ğŸš€ ëŒ€í•™ë¡œì  í™€ ë§¤ì¶œ í˜¸ì¡°</span>
                                ê·¹ë‹¨ ì œíœ´ íš¨ê³¼ë¡œ í™€ ë¹„ì¤‘ 80% ë‹¬ì„±. 2030 íƒ€ê²Ÿ ì ì¤‘.
                            </li>
                        </ul>
                    </div>
                </div>
            `;
            setTimeout(() => initChart('mainChart', 'line', [100, 120, 115, 140, 135, 160, 170]), 50);
        }

        // 2. Marketing Status (HQ) - Live
        function renderMarketing(container) {
            const f = getFactor();
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    ${createCard('ì´ ê´‘ê³ ë¹„', fmtMoney(850000 * f), '+5%', 'ph-megaphone', 'text-pink-500')}
                    ${createCard('ì „ì²´ ROAS', '380%', '-12%', 'ph-trend-up', 'text-blue-500')}
                    ${createCard('í´ë¦­ë‹¹ ë¹„ìš©(CPC)', '450ì›', '+20ì›', 'ph-cursor-click', 'text-indigo-500')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ì±„ë„ë³„ íš¨ìœ¨ (ROAS)</h3>
                        <canvas id="roasChart" height="200"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ë°°ë‹¬ í”Œë«í¼ ê´‘ê³  ì„±ê³¼</h3>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500"><tr><th class="p-2">ì±„ë„</th><th class="p-2">ê´‘ê³ ë¹„</th><th class="p-2">ë§¤ì¶œ</th><th class="p-2">ROAS</th></tr></thead>
                            <tbody>
                                <tr class="border-b"><td class="p-2">ë°°ë‹¬ì˜ë¯¼ì¡±</td><td class="p-2">50ë§Œì›</td><td class="p-2">200ë§Œì›</td><td class="p-2 text-blue-600 font-bold">400%</td></tr>
                                <tr class="border-b"><td class="p-2">ì¿ íŒ¡ì´ì¸ </td><td class="p-2">80ë§Œì›</td><td class="p-2">280ë§Œì›</td><td class="p-2 text-yellow-600 font-bold">350%</td></tr>
                                <tr><td class="p-2">ìš”ê¸°ìš”</td><td class="p-2">20ë§Œì›</td><td class="p-2">50ë§Œì›</td><td class="p-2 text-red-600 font-bold">250%</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            setTimeout(() => initChart('roasChart', 'bar', [400, 350, 250, 500], ['ë°°ë¯¼', 'ì¿ íŒ¡', 'ìš”ê¸°ìš”', 'ë„¤ì´ë²„']), 50);
        }

        // 3. Menu/Cost Status (HQ) - Live
        function renderMenuCost(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ë©”ë‰´ ABC ë¶„ì„ (ë§¤ì¶œ ê¸°ì—¬ë„)</h3>
                        <canvas id="abcChart" height="200"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">ì›ê°€ìœ¨ ë†’ì€ ë§¤ì¥ Top 3</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between items-center">
                                <span>1. ê°•ë‚¨ì </span>
                                <span class="text-red-500 font-bold">42.5% (Warning)</span>
                            </li>
                            <li class="flex justify-between items-center">
                                <span>2. ì‹ ë‹¹ì </span>
                                <span class="text-yellow-500 font-bold">38.0%</span>
                            </li>
                            <li class="flex justify-between items-center">
                                <span>3. ëŒ€í•™ë¡œì </span>
                                <span class="text-green-500 font-bold">34.2% (Good)</span>
                            </li>
                        </ul>
                        <div class="mt-6 bg-slate-50 p-3 rounded text-xs text-slate-500">
                            * ê°•ë‚¨ì ì€ ê°ˆë¹„íŒŒì´ ì‹ ë©”ë‰´ ë¡œìŠ¤ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤. ë°œì£¼ëŸ‰ ì¡°ì ˆì´ í•„ìš”í•©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => initChart('abcChart', 'doughnut', [45, 30, 15, 10], ['Aë“±ê¸‰ (ê°ˆë¹„íŒŒì´)', 'Bë“±ê¸‰ (ì¹˜ì¦ˆë²„ê±°)', 'Cë“±ê¸‰ (ì‚¬ì´ë“œ)', 'Dë“±ê¸‰']), 50);
        }

        // 4. Store Operation Management (HQ) - Live
        function renderStoreMgmt(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">QSC ì ê²€ í˜„í™© (ìµœê·¼ 1ì£¼)</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded hover:bg-blue-50 cursor-pointer">
                                <div>
                                    <div class="font-bold">ëŒ€í•™ë¡œì </div>
                                    <div class="text-xs text-slate-500">ì ê²€ì: ê¹€í‰ì•ˆ SV</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-blue-600 font-bold text-lg">95ì </div>
                                    <div class="text-xs text-slate-400">2025.11.18</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded hover:bg-blue-50 cursor-pointer">
                                <div>
                                    <div class="font-bold">ê°•ë‚¨ì </div>
                                    <div class="text-xs text-slate-500">ì ê²€ì: ì´ì¤€ìš© ë³¸ë¶€ì¥</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-yellow-600 font-bold text-lg">82ì </div>
                                    <div class="text-xs text-slate-400">2025.11.15</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold mb-4">QSC - ë§¤ì¶œ ìƒê´€ê´€ê³„</h3>
                        <canvas id="qscChart" height="200"></canvas>
                        <p class="mt-4 text-xs text-slate-500 text-center">QSC ì ìˆ˜ê°€ 90ì  ì´ìƒì¸ ë§¤ì¥ì€ í‰ê·  ë§¤ì¶œì´ 15% ë†’ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
            setTimeout(() => initChart('qscChart', 'scatter', 
                [{x: 80, y: 200}, {x: 85, y: 240}, {x: 90, y: 300}, {x: 95, y: 350}], 
                [], 'scatter'
            ), 50);
        }

        // 5. Performance Analysis (Partner) - Live
        function renderPerformance(container) {
            const f = getFactor();
            const revenue = 35000000 * f / 30;
            const cost = revenue * 0.38; // 38% Cost
            const profit = revenue - cost - (revenue * 0.1); // 10% rent/etc
            
            container.innerHTML = `
                <h3 class="text-lg font-bold mb-4">ì†ìµ ë¶„ì„ (Profit & Loss)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500">
                        <div class="text-sm text-slate-500">ì´ ë§¤ì¶œ</div>
                        <div class="text-2xl font-bold text-navy-900">${fmtMoney(revenue)}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-400">
                        <div class="text-sm text-slate-500">ì´ ë¹„ìš© (ì›ê°€+íŒê´€ë¹„)</div>
                        <div class="text-2xl font-bold text-slate-700">${fmtMoney(cost + revenue*0.1)}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-green-500">
                        <div class="text-sm text-slate-500">ì˜ì—… ì´ìµ</div>
                        <div class="text-2xl font-bold text-green-600">${fmtMoney(profit)}</div>
                        <div class="text-xs text-green-500 mt-1">ì´ìµë¥  22%</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-4">ë¹„ìš© êµ¬ì„± ìƒì„¸</h3>
                    <canvas id="costDetailChart" height="150"></canvas>
                </div>
            `;
            setTimeout(() => initChart('costDetailChart', 'bar', [cost, revenue*0.1, revenue*0.05, revenue*0.2], ['ì¬ë£Œë¹„', 'ì„ëŒ€ë£Œ', 'ê³µê³¼ê¸ˆ', 'ì¸ê±´ë¹„']), 50);
        }

        // 6. Automation (Partner) - Live
        function renderAutomation(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center">
                                <div class="p-2 bg-blue-100 rounded-lg mr-3 text-blue-600"><i class="ph ph-robot text-2xl"></i></div>
                                <div>
                                    <h3 class="font-bold text-lg">AI ê´‘ê³  ì—ì´ì „íŠ¸</h3>
                                    <p class="text-xs text-slate-500">ROAS ìµœì í™”ë¥¼ ìœ„í•´ ì…ì°°ê°€ë¥¼ ìë™ ì¡°ì •í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="ai-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-blue-600"/>
                                <label for="ai-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer checked:bg-blue-600"></label>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg text-sm space-y-2">
                            <div class="flex justify-between"><span>í˜„ì¬ ìƒíƒœ</span><span class="text-green-600 font-bold">ì‘ë™ ì¤‘ (Active)</span></div>
                            <div class="flex justify-between"><span>ì˜¤ëŠ˜ ì ˆê°ì•¡</span><span class="font-bold">12,500ì›</span></div>
                            <div class="flex justify-between"><span>íƒ€ê²Ÿ ROAS</span><span class="font-bold">400%</span></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-purple-100">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center">
                                <div class="p-2 bg-purple-100 rounded-lg mr-3 text-purple-600"><i class="ph ph-chat-teardrop-text text-2xl"></i></div>
                                <div>
                                    <h3 class="font-bold text-lg">ë¦¬ë·° ìë™ ë‹µê¸€</h3>
                                    <p class="text-xs text-slate-500">ê¸ì • ë¦¬ë·°ì— ê°ì‚¬ ì¸ì‚¬ë¥¼ ìë™ìœ¼ë¡œ ë‚¨ê¹ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                             <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label class="toggle-label block overflow-hidden h-6 rounded-full bg-blue-600 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-2">ìµœê·¼ ìë™ ë‹µê¸€ ì˜ˆì‹œ:</p>
                            <p class="text-sm italic text-slate-700">"ê³ ê°ë‹˜, ì†Œì¤‘í•œ ë³„ì  5ì  ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¤ìŒì—ë„ ë§›ìˆëŠ” ë²„ê±°ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤ :)"</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 7. AI Report Center (Fix & Logic)
        function renderAIReportCenter(container) {
            container.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-navy-900">AI ë¦¬í¬íŠ¸ ì„¼í„°</h2>
                    <p class="text-slate-500">ì˜¤ë¥˜ê°€ ìˆ˜ì •ë˜ì–´ ì •ìƒ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div onclick="generateReport('weekly')" class="bg-white p-8 rounded-2xl shadow-lg hover:border-blue-400 border border-transparent transition cursor-pointer flex flex-col items-center text-center group">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600 group-hover:scale-110 transition"><i class="ph ph-presentation-chart text-3xl"></i></div>
                        <h3 class="text-xl font-bold mb-2">ë³¸ì‚¬ ì£¼ê°„ íšŒì˜ ìë£Œ</h3>
                        <p class="text-sm text-slate-500 mb-4">ì „ì‚¬ ë§¤ì¶œ, OKR ì´ìŠˆ ë¶„ì„ ë¦¬í¬íŠ¸</p>
                        <span class="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1 rounded-full">-5 Coin</span>
                    </div>
                    <div onclick="generateReport('store')" class="bg-white p-8 rounded-2xl shadow-lg hover:border-indigo-400 border border-transparent transition cursor-pointer flex flex-col items-center text-center group">
                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4 text-indigo-600 group-hover:scale-110 transition"><i class="ph ph-store-front text-3xl"></i></div>
                        <h3 class="text-xl font-bold mb-2">ê°€ë§¹ì  ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                        <p class="text-sm text-slate-500 mb-4">SV ë°©ë¬¸ìš© ë§¤ì¥ ì§„ë‹¨ ë¦¬í¬íŠ¸</p>
                        <span class="text-indigo-600 font-bold text-sm bg-indigo-50 px-3 py-1 rounded-full">-1 Coin</span>
                    </div>
                </div>
                <div id="report-result" class="mt-8 bg-white p-8 rounded-2xl shadow-xl border border-slate-200 hidden">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h3 class="text-xl font-bold"><i class="ph ph-file-text mr-2"></i>Report View</h3>
                        <button onclick="document.getElementById('report-result').classList.add('hidden')"><i class="ph ph-x text-xl"></i></button>
                    </div>
                    <div id="report-content" class="prose max-w-none text-sm"></div>
                </div>
            `;
        }

        async function generateReport(type) {
            const cost = type === 'weekly' ? 5 : 1;
            if(COINS < cost) return alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
            if(!confirm(`${cost} ì½”ì¸ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            COINS -= cost;
            updateCoinDisplay();
            
            const resultDiv = document.getElementById('report-result');
            const contentDiv = document.getElementById('report-content');
            resultDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<div class="flex flex-col items-center py-12"><div class="loader mb-4"></div><p>AI ë¶„ì„ ì¤‘...</p></div>';
            resultDiv.scrollIntoView({ behavior: 'smooth' });

            // Fallback Content (To ensure it works even if API fails)
            const fallbackContent = type === 'weekly' ? 
                `# 2025ë…„ 11ì›” 3ì£¼ì°¨ ë³¸ì‚¬ ì£¼ê°„ íšŒì˜ë¡
## 1. ê²°ì •ì‚¬í•­
| í•­ëª© | ë‚´ìš© | ë‹´ë‹¹ì |
|---|---|---|
| ê°•ë‚¨ì  ìˆ˜ìµì„± | ì¿ íŒ¡ì´ì¸  í”„ë¡œëª¨ì…˜ ì¶•ì†Œ ë° ì„¸íŠ¸ ë©”ë‰´ ê°€ê²© 500ì› ì¸ìƒ ê²°ì • | ì´ì¤€ìš© |
| ëŒ€í•™ë¡œì  ë§ˆì¼€íŒ… | ê·¹ë‹¨ ì œíœ´ í‹°ì¼“ í”„ë¡œëª¨ì…˜ 12ì›”ê¹Œì§€ ì—°ì¥ í™•ì • | ë°•ìš”í•œ |

## 2. ì•¡ì…˜ ì•„ì´í…œ
* **[ìš´ì˜]** ì‹ ë‹¹ì  QSC ê¸´ê¸‰ ì ê²€ (ì´ë²ˆì£¼ ê¸ˆìš”ì¼ê¹Œì§€) - ê¹€í‰ì•ˆ SV
* **[ê°œë°œ]** ë ˆìŠ¤í† ì§€ë‹ˆ ê°€ë§¹ì ìš© ì•± ë² íƒ€ í…ŒìŠ¤íŠ¸ (ë‹¤ìŒì£¼ ì›”ìš”ì¼ ì‹œì‘) - ê¹€ë„ìœ¤

## 3. íšŒì˜ ë§¥ë½
ê°•ë‚¨ì  ë°°ë‹¬ ë§¤ì¶œì€ ëŠ˜ì—ˆìœ¼ë‚˜ ì´ìµë¥ ì´ 10%ëŒ€ë¡œ ë–¨ì–´ì ¸ ìš°ë ¤ê°€ í½ë‹ˆë‹¤. ë°˜ë©´ ëŒ€í•™ë¡œì ì€ í™€ ë§¤ì¶œ ë¹„ì¤‘ì´ ë†’ì•„ ì•ˆì •ì ì…ë‹ˆë‹¤.` 
                : 
                `# ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸ (${CURRENT_STORE === 'daehakro' ? 'ëŒ€í•™ë¡œì ' : 'ê°•ë‚¨ì '})
## 1. ë§¤ì¶œ ë¶„ì„
* **í˜„í™©**: ì „ì›” ëŒ€ë¹„ ë§¤ì¶œ 12.5% ìƒìŠ¹. íŠ¹íˆ ì ì‹¬ ì‹œê°„ëŒ€ íšŒì „ìœ¨ì´ ì¢‹ìŠµë‹ˆë‹¤.
* **ì œì•ˆ**: ì €ë… ì‹œê°„ëŒ€ ì£¼ë¥˜ ì„¸íŠ¸ ë©”ë‰´ ì¶”ê°€ë¥¼ í†µí•œ ê°ë‹¨ê°€ ìƒìŠ¹ ìœ ë„ í•„ìš”.

## 2. QSC ì ê²€
* **ìœ„ìƒ**: ì£¼ë°© ë°”ë‹¥ ì²­ê²° ìƒíƒœ ìš°ìˆ˜ (95ì )
* **ì„œë¹„ìŠ¤**: ì•Œë°”ìƒ ì‘ëŒ€ ë§¤ë‰´ì–¼ ì¬êµìœ¡ í•„ìš” (ë¯¸ì†Œ ì‘ëŒ€ ë¶€ì¡±)

## 3. ì´í‰
ì „ë°˜ì ìœ¼ë¡œ ê´€ë¦¬ê°€ ì˜ ë˜ê³  ìˆìœ¼ë‚˜, í”¼í¬íƒ€ì„ ì¸ë ¥ ë°°ì¹˜ë¥¼ ìµœì í™”í•˜ë©´ ë§¤ì¶œ 5% ì¶”ê°€ ìƒìŠ¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;

            try {
                // Try Real API Call
                const prompt = type === 'weekly' ? "ì£¼ê°„ íšŒì˜ë¡ ì‘ì„±í•´ì¤˜" : "ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸ ì‘ì„±í•´ì¤˜";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error("API Error");
                contentDiv.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                console.warn("API Failed, using fallback");
                contentDiv.innerHTML = marked.parse(fallbackContent); // Seamless Fallback
            }
        }

        // --- Helper: Create Card HTML ---
        function createCard(title, value, diff, icon, color) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-slate-500 text-sm font-medium">${title}</span>
                        <i class="ph ${icon} ${color} text-xl bg-slate-50 p-2 rounded-lg"></i>
                    </div>
                    <div class="text-2xl font-bold text-navy-900 mb-1">${value}</div>
                    <div class="flex items-center text-xs ${diff.includes('+') ? 'text-red-500' : 'text-blue-500'}">
                        <i class="ph ${diff.includes('+') ? 'ph-trend-up' : 'ph-trend-down'} mr-1"></i>
                        <span>${diff} vs ì§€ë‚œë‹¬</span>
                    </div>
                </div>
            `;
        }

        // --- Helper: Init Chart.js ---
        let currentChart = null;
        function initChart(id, type, data, labels) {
            const ctx = document.getElementById(id);
            if(!ctx) return;
            
            // Dummy data scaling based on labels or type
            const chartData = {
                labels: labels || ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                datasets: [{
                    label: 'Data',
                    data: data,
                    backgroundColor: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'],
                    borderColor: '#2563eb',
                    borderWidth: 1
                }]
            };

            if(type === 'scatter') {
                 chartData.datasets[0].data = data; // Scatter uses objects {x,y}
                 chartData.labels = undefined;
            }

            new Chart(ctx, {
                type: type,
                data: chartData,
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type !== 'bar' && type !== 'line' } }
                }
            });
        }

        // --- Chatbot & Coin Logic ---
        function updateCoinDisplay() {
            document.querySelectorAll('#coin-balance').forEach(el => el.innerText = `${COINS} C`);
            localStorage.setItem('restogenie_coins', COINS);
        }
        function rechargeCoins() { COINS += 10; updateCoinDisplay(); alert("ì¶©ì „ ì™„ë£Œ!"); }
        function toggleChatbot() { document.getElementById('chatbot-modal').classList.toggle('hidden'); }
        function handleChatKey(e) { if(e.key==='Enter') sendChat(); }
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            const history = document.getElementById('chat-history');
            history.innerHTML += `<div class="flex gap-2 flex-row-reverse"><div class="bg-blue-600 text-white p-3 rounded-l-xl rounded-br-xl text-sm">${text}</div></div>`;
            input.value = '';
            
            // Simple Mock Response for Chat
            setTimeout(() => {
                history.innerHTML += `<div class="flex gap-2"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="ph ph-robot"></i></div><div class="bg-white p-3 rounded-r-xl rounded-bl-xl text-sm border border-slate-100">í™•ì¸í–ˆìŠµë‹ˆë‹¤. "${text}"ì— ëŒ€í•œ ë¶„ì„ ê²°ê³¼, ê°•ë‚¨ì ì˜ ë°°ë‹¬ ë¹„ì¤‘ì´ ë†’ì•„ì§€ê³  ìˆìœ¼ë‚˜ ê³µí—Œì´ìµë¥  ê´€ë¦¬ê°€ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.</div></div>`;
                history.scrollTop = history.scrollHeight;
            }, 1000);
        }
        function handleStoreChange() {
             const sel = document.getElementById('store-selector');
             CURRENT_STORE = sel.value;
             renderPage('dashboard');
        }
    </script>
</body>
</html>
