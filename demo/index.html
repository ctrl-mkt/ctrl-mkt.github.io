<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie - í†µí•© í”„ëœì°¨ì´ì¦ˆ ê´€ë¦¬ ì†”ë£¨ì…˜</title>
    
    <!-- Fonts (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Charts (ApexCharts) -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Utility */
        .hidden-force { display: none !important; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#1e293b',
                        navyDark: '#0f172a',
                        blueMain: '#3b82f6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-950 text-slate-200 selection:bg-blue-500/30 overflow-x-hidden">

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 relative z-50">
        <div class="bg-slate-900 border border-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="text-center mb-10">
                <div class="w-16 h-16 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30">
                    <i data-lucide="sparkles" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">RestoGenie</h1>
                <p class="text-slate-400">ë°ì´í„° ê¸°ë°˜ í”„ëœì°¨ì´ì¦ˆ í†µí•© ê´€ë¦¬</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">ì•„ì´ë””</label>
                    <input type="text" id="login-id" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="ID ì…ë ¥">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-pw" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="Password ì…ë ¥">
                </div>
                <button onclick="app.login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-blue-500/25 mt-4">ë¡œê·¸ì¸</button>
                
                <!-- Quick Login Hints -->
                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-xs text-slate-500 mt-4 border border-slate-700/50">
                    <p class="mb-2 font-bold text-slate-400">ì²´í—˜ ê³„ì • (í´ë¦­ ì‹œ ìë™ ì…ë ¥)</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="app.fillLogin('demo', 'ctrlm2025!')" class="hover:text-blue-400 underline">ë³¸ì‚¬(HQ)</button>
                        <span class="text-slate-600">|</span>
                        <button onclick="app.fillLogin('partner', 'ctrlm2025!')" class="hover:text-blue-400 underline">ê°€ë§¹ì ì£¼(PT)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= APP LAYOUT ================= -->
    <div id="app-layout" class="hidden-force min-h-screen flex bg-slate-950">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-slate-900 border-r border-slate-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
            <!-- Logo -->
            <div class="h-20 flex items-center px-6 border-b border-slate-800 flex-shrink-0">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                    <i data-lucide="sparkles" class="text-white w-5 h-5"></i>
                </div>
                <span class="text-xl font-bold text-white tracking-tight">RestoGenie</span>
            </div>

            <!-- Menu Items -->
            <div class="flex-1 p-4 space-y-8 overflow-y-auto custom-scrollbar">
                <div id="sidebar-menu-main">
                    <!-- Injected by JS -->
                </div>
                <div id="sidebar-menu-ai">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 px-2">AI Center</div>
                    <!-- Injected by JS -->
                </div>
            </div>
            
            <!-- User Profile -->
            <div class="p-4 bg-slate-900 border-t border-slate-800 flex-shrink-0">
                <div class="flex items-center gap-3 px-2">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-600 flex items-center justify-center text-xs font-bold text-white border border-slate-500">HQ</div>
                    <div class="flex-1 min-w-0">
                        <div id="user-name" class="text-sm font-bold text-white truncate">ê´€ë¦¬ì</div>
                        <div id="user-role" class="text-xs text-slate-400 truncate">ë³¸ì‚¬</div>
                    </div>
                    <button onclick="app.logout()" class="p-2 text-slate-500 hover:text-red-400 transition-colors" title="ë¡œê·¸ì•„ì›ƒ">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- MOBILE OVERLAY -->
        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm"></div>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="flex-1 lg:pl-64 flex flex-col min-w-0 w-full transition-all duration-300">
            
            <!-- TOP HEADER -->
            <header class="h-20 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-30 px-4 md:px-8 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="app.toggleSidebar()" class="lg:hidden text-white p-2 hover:bg-slate-800 rounded-lg">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Store Selector (HQ) -->
                    <div id="store-selector" class="hidden relative group">
                        <button class="flex items-center gap-2 bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg hover:border-blue-500 transition-colors min-w-[160px] justify-between text-sm md:text-base">
                            <span class="flex items-center gap-2">
                                <i data-lucide="store" class="text-blue-400 w-4 h-4"></i> 
                                <span id="current-store-name">ì „ì‚¬ (HQ Total)</span>
                            </span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                        </button>
                    </div>
                    
                    <!-- Partner Title (PT) -->
                    <h2 id="partner-title" class="hidden text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="store" class="text-blue-400 w-5 h-5"></i> 
                        <span class="hidden md:inline">ìŠ¬ë¨ë²„ê±°</span> ê°•ë‚¨ì 
                    </h2>
                </div>

                <!-- Right Icons -->
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="flex items-center gap-2 bg-slate-800 px-3 py-1.5 md:px-4 md:py-2 rounded-full border border-slate-700 hover:border-slate-600 transition-colors cursor-pointer" onclick="app.openAdModal()">
                        <i data-lucide="coins" class="text-amber-400 w-4 h-4"></i>
                        <span id="coin-balance" class="text-white font-bold text-sm">100</span>
                        <div class="h-3 w-px bg-slate-600 mx-1"></div>
                        <span class="text-xs text-blue-400 font-medium hover:text-blue-300">ì¶©ì „</span>
                    </div>
                    <button class="text-slate-400 hover:text-white relative p-1">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                </div>
            </header>

            <!-- MAIN CONTENT AREA -->
            <main id="main-content" class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
                <!-- Content will be injected here -->
            </main>

        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- AI Report Modal -->
    <div id="modal-ai" class="hidden-force fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-3xl h-[85vh] rounded-2xl border border-slate-700 flex flex-col shadow-2xl transform transition-all">
            <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-800/50 rounded-t-2xl">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="file-text" class="text-blue-400 w-6 h-6"></i> 
                    <span id="ai-modal-title">AI ë¦¬í¬íŠ¸ ìƒì„±</span>
                </h3>
                <button onclick="app.closeModal('modal-ai')" class="text-slate-400 hover:text-white p-1 rounded-lg hover:bg-slate-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scrollbar" id="ai-modal-content">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- Ad Modal -->
    <div id="modal-ad" class="hidden-force fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
            <h3 class="text-xl font-bold text-slate-900 mb-4">ê´‘ê³  ì‹œì²­ ì¤‘...</h3>
            <div class="aspect-video bg-slate-100 rounded-xl mb-6 flex items-center justify-center overflow-hidden relative">
                <i data-lucide="play-circle" class="text-slate-300 w-16 h-16 relative z-10"></i>
                <div class="absolute inset-0 bg-gradient-to-tr from-slate-200 to-white opacity-50 animate-pulse"></div>
            </div>
            <div class="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden">
                <div id="ad-progress" class="h-full bg-blue-600 transition-all duration-100" style="width: 0%"></div>
            </div>
            <button id="ad-btn" disabled onclick="app.completeAd()" class="w-full py-3 rounded-xl font-bold bg-slate-200 text-slate-400 transition-colors cursor-not-allowed">
                ì‹œì²­ ì¤‘...
            </button>
        </div>
    </div>

    <!-- Chat Bot Widget -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col items-end">
        <div id="chat-window" class="hidden-force bg-slate-900 border border-slate-700 w-80 md:w-96 h-[500px] rounded-2xl shadow-2xl flex flex-col mb-4 overflow-hidden animate-fade-in">
            <div class="bg-blue-600 p-4 flex justify-between items-center flex-shrink-0">
                <span class="text-white font-bold flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> RestoBot AI
                </span>
                <button onclick="app.toggleChat()" class="text-white/80 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/95 custom-scrollbar">
                <div class="flex justify-start">
                    <div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none border border-slate-700 text-sm max-w-[85%] shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! RestoGenie AIì…ë‹ˆë‹¤. ë§¤ì¥ ë°ì´í„°ë‚˜ íšŒì˜ë¡ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”? ğŸ”
                    </div>
                </div>
            </div>
            <div class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2 flex-shrink-0">
                <input id="chat-input" type="text" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500 placeholder-slate-500" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.key==='Enter') app.sendChatMessage()">
                <button onclick="app.sendChatMessage()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <button onclick="app.toggleChat()" class="bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-full shadow-xl transition-transform hover:scale-105 flex items-center justify-center group">
            <i data-lucide="message-square" class="w-6 h-6 group-hover:animate-bounce"></i>
        </button>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        // API Key setup
        const GEMINI_API_KEY = "AIzaSyCILSrQKjRiupRcyNd1pFJUksNMkGVY8AQ"; 

        // --- Mock Data ---
        const DB = {
            gangnam: {
                name: 'ê°•ë‚¨ì ',
                dailySales: [1817700, 1546200, 1982900, 1602400, 2546200, 2897600, 1508700],
                dates: ['11/10', '11/11', '11/12', '11/13', '11/14', '11/15', '11/16'],
                topMenus: [
                    { name: 'ë” í¬ë¦¬ìŠ¤í”¼ ê°ˆë¹„ ë²„ê±° SET', count: 450, revenue: 4365000 },
                    { name: 'ë” ë¹„í”„ ë²„ê±° SET', count: 380, revenue: 3686000 },
                    { name: 'ì¹˜ì¦ˆë²„ê±° SET', count: 210, revenue: 1869000 },
                    { name: 'ë§¥ì•¤ì¹˜ì¦ˆ ë²„ê±°', count: 150, revenue: 1185000 }
                ],
                channelMix: [55, 45], // Hall, Delivery
                cctv: { traffic: 12450, visit: 1845, conversion: 14.8 }
            },
            okr: `[2025-11-11 OKR íšŒì˜ë¡ ìš”ì•½]\n- ê²°ì •ì‚¬í•­: ê°•ë‚¨ì  ëŸ°ì¹˜ ë©”ë‰´ ë³€ê²½(11/12), ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì¿ í° ë°œê¸‰, B2B ë°ëª¨ ì·¨ì†Œ.\n- ê°•ë‚¨ì  ì´ìŠˆ: ë””ë„ˆ í¬ì¥ í• ì¸ ì¢…ë£Œ (ì‹¤íš¨ì„± ë‚®ìŒ).\n- ëª©í‘œ: 11ì›” ì „ì‚¬ ë§¤ì¶œ 2.7ì–µ ë‹¬ì„± (í˜„ì¬ 72% ë‹¬ì„±).`
        };

        // --- App Logic ---
        const app = {
            userType: null,
            coins: 100,
            currentStore: 'gangnam',

            init: function() {
                // Initialize Lucide Icons on Load
                lucide.createIcons();
                console.log("App Initialized");
            },

            fillLogin: function(id, pw) {
                document.getElementById('login-id').value = id;
                document.getElementById('login-pw').value = pw;
            },

            login: function() {
                const id = document.getElementById('login-id').value;
                const pw = document.getElementById('login-pw').value;

                if (id === 'demo' && pw === 'ctrlm2025!') {
                    this.userType = 'hq';
                    this.loadDashboard();
                } else if (id === 'partner' && pw === 'ctrlm2025!') {
                    this.userType = 'partner';
                    this.loadDashboard();
                } else {
                    alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\n(Demo: demo / ctrlm2025!)');
                }
            },

            logout: function() {
                this.userType = null;
                document.getElementById('login-id').value = '';
                document.getElementById('login-pw').value = '';
                document.getElementById('app-layout').classList.add('hidden-force');
                document.getElementById('login-screen').classList.remove('hidden-force');
            },

            loadDashboard: function() {
                document.getElementById('login-screen').classList.add('hidden-force');
                document.getElementById('app-layout').classList.remove('hidden-force');
                
                const isHQ = this.userType === 'hq';
                
                // Update Profile UI
                document.getElementById('user-avatar').innerText = isHQ ? 'HQ' : 'PT';
                document.getElementById('user-name').innerText = isHQ ? 'ê¹€ë„ìœ¤ íŒ€ì¥' : 'ë°•ìš”í•œ ì ì£¼';
                document.getElementById('user-role').innerText = isHQ ? 'ìš´ì˜ë³¸ë¶€' : 'ê°•ë‚¨ì ';
                
                // Update Header UI
                if(isHQ) {
                    document.getElementById('store-selector').classList.remove('hidden');
                    document.getElementById('partner-title').classList.add('hidden');
                } else {
                    document.getElementById('store-selector').classList.add('hidden');
                    document.getElementById('partner-title').classList.remove('hidden');
                }

                this.renderSidebar();
                this.renderMainContent('dashboard');
                this.updateCoinDisplay();
                
                // Re-render icons
                setTimeout(() => lucide.createIcons(), 50);
            },

            renderSidebar: function() {
                const mainContainer = document.getElementById('sidebar-menu-main');
                const aiContainer = document.getElementById('sidebar-menu-ai');
                const isHQ = this.userType === 'hq';

                const mainItems = isHQ ? [
                    { id: 'dashboard', icon: 'layout-dashboard', label: 'ì¢…í•© ëŒ€ì‹œë³´ë“œ' },
                    { id: 'sales', icon: 'trending-up', label: 'ë§¤ì¶œ ë¶„ì„' },
                    { id: 'stores', icon: 'store', label: 'ê°€ë§¹ì  ê´€ë¦¬' },
                    { id: 'marketing', icon: 'users', label: 'ë§ˆì¼€íŒ… ì„±ê³¼' }
                ] : [
                    { id: 'dashboard', icon: 'layout-dashboard', label: 'ë‚´ ë§¤ì¥ í™ˆ' },
                    { id: 'sales', icon: 'dollar-sign', label: 'ë§¤ì¶œ/ì†ìµ' },
                    { id: 'menu', icon: 'shopping-bag', label: 'ë©”ë‰´ ë¶„ì„' },
                    { id: 'reviews', icon: 'message-square', label: 'ë¦¬ë·° ê´€ë¦¬' }
                ];

                const aiItems = isHQ ? [
                    { id: 'ai_report', icon: 'file-text', label: 'AI ê²½ì˜ ë¦¬í¬íŠ¸', highlight: true }
                ] : [
                    { id: 'ai_consult', icon: 'file-text', label: 'AI ë§¤ì¥ ì»¨ì„¤íŒ…', highlight: true }
                ];

                // Safe HTML generation
                const generateMenuHTML = (items) => items.map(item => `
                    <button onclick="app.renderMainContent('${item.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-slate-800 text-slate-400 hover:text-white group">
                        <i data-lucide="${item.icon}" class="w-5 h-5 ${item.highlight ? 'text-amber-400' : ''}"></i>
                        <span class="font-medium ${item.highlight ? 'text-white' : ''}">${item.label}</span>
                    </button>
                `).join('');

                mainContainer.innerHTML = `
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 px-2">Main Menu</div>
                    <nav class="space-y-1">${generateMenuHTML(mainItems)}</nav>
                `;
                aiContainer.innerHTML = `
                    <nav class="space-y-1">${generateMenuHTML(aiItems)}</nav>
                `;
            },

            renderMainContent: function(pageId) {
                const content = document.getElementById('main-content');
                const isHQ = this.userType === 'hq';
                
                // Close sidebar on mobile if open
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 1024) {
                    this.toggleSidebar();
                }

                if(pageId === 'dashboard') {
                    const data = DB.gangnam;
                    const totalSales = data.dailySales.reduce((a,b) => a+b, 0);
                    
                    // HTML Templates separated for cleaner code
                    const aiButton = isHQ 
                        ? `<button onclick="app.openAiModal('hq')" class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 text-white px-4 py-2 rounded-lg shadow-lg transition-all hover:scale-105">
                             <i data-lucide="sparkles" class="w-4 h-4"></i> AI ì£¼ê°„ íšŒì˜ ìë£Œ
                           </button>` 
                        : `<button onclick="app.openAiModal('partner')" class="flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 text-white px-4 py-2 rounded-lg shadow-lg transition-all hover:scale-105">
                             <i data-lucide="sparkles" class="w-4 h-4"></i> ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸ (1ì½”ì¸)
                           </button>`;

                    const weatherWidget = isHQ 
                        ? `<div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 class="text-lg font-bold text-white mb-4">ë§¤ì¥ë³„ ì´ìŠˆ ìš”ì•½</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-500 uppercase bg-slate-700/50">
                                        <tr><th class="px-4 py-3">ë§¤ì¥</th><th class="px-4 py-3">ìƒíƒœ</th><th class="px-4 py-3">ë‹¬ì„±ë¥ </th><th class="px-4 py-3">ì´ìŠˆ</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b border-slate-800 hover:bg-slate-700/20"><td class="px-4 py-3 font-medium text-white">ê°•ë‚¨ì </td><td class="px-4 py-3"><span class="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-xs">ì˜ì—…ì¤‘</span></td><td class="px-4 py-3">94%</td><td class="px-4 py-3 text-amber-400">ë°°ë‹¬ë¹„</td></tr>
                                        <tr class="border-b border-slate-800 hover:bg-slate-700/20"><td class="px-4 py-3 font-medium text-white">ëŒ€í•™ë¡œì </td><td class="px-4 py-3"><span class="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-xs">ì˜ì—…ì¤‘</span></td><td class="px-4 py-3">88%</td><td class="px-4 py-3">-</td></tr>
                                    </tbody>
                                </table>
                            </div>
                           </div>` 
                        : `<div class="bg-slate-800 rounded-xl p-6 border border-slate-700 flex flex-col items-center justify-center text-center h-full min-h-[200px]">
                            <div class="text-5xl mb-4">ğŸŒ¤ï¸</div>
                            <h4 class="text-white font-bold text-lg">ì˜¤ëŠ˜ ë‚ ì”¨: ë§‘ìŒ</h4>
                            <p class="text-sm text-slate-400 mt-2">ì•¼ì™¸ í™œë™ì´ ë§ì•„ <span class="text-blue-400 font-bold">í™€ ë§¤ì¶œ ë¹„ì¤‘</span>ì´<br/>ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.</p>
                           </div>`;

                    const topMenusHTML = data.topMenus.map((m, i) => `
                        <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-lg border border-slate-800">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i===0?'bg-amber-500 text-black':'bg-slate-700 text-slate-300'}">${i+1}</div>
                                <span class="text-slate-200 text-sm truncate max-w-[120px] md:max-w-none">${m.name}</span>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-white font-bold text-sm">${m.count}ê°œ</div>
                                <div class="text-xs text-slate-500">${m.revenue.toLocaleString()}ì›</div>
                            </div>
                        </div>`).join('');

                    content.innerHTML = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-2">
                            <div>
                                <h1 class="text-2xl font-bold text-white mb-1">${isHQ ? '11ì›” ì¢…í•© í˜„í™©' : 'ë§¤ì¥ ì‹¤ì‹œê°„ í˜„í™©'}</h1>
                                <p class="text-slate-400 text-sm">ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}</p>
                            </div>
                            <div class="flex gap-2">
                                ${isHQ ? '<button class="p-2 bg-slate-800 border border-slate-700 rounded hover:bg-slate-700 text-slate-300"><i data-lucide="printer" class="w-4 h-4"></i></button>' : ''}
                                ${aiButton}
                            </div>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${this.createKpiCard('ëˆ„ì  ë§¤ì¶œ (11ì›”)', totalSales.toLocaleString()+'ì›', 12.5, 'dollar-sign', 'blue')}
                            ${this.createKpiCard('ì´ ì£¼ë¬¸ ìˆ˜', '1,350ê±´', 8.2, 'shopping-bag', 'green')}
                            ${this.createKpiCard('CCTV ìœ ë™ì¸êµ¬', '12,450ëª…', -2.1, 'users', 'purple')}
                            ${this.createKpiCard('ë°°ë‹¬ ë¹„ì¤‘', '45%', 5.4, 'trending-up', 'amber')}
                        </div>

                        <!-- Charts Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i> ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
                                <div id="chart-sales" class="h-72 w-full"></div>
                            </div>
                            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4 text-amber-400"></i> ì±„ë„ë³„ ë¹„ì¤‘</h3>
                                <div id="chart-channel" class="h-72 w-full flex items-center justify-center"></div>
                            </div>
                        </div>
                        
                        <!-- Bottom Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-10">
                            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                <h3 class="text-lg font-bold text-white mb-4">íŒë§¤ Top 4 ë©”ë‰´</h3>
                                <div class="space-y-3">${topMenusHTML}</div>
                            </div>
                            ${weatherWidget}
                        </div>
                    </div>`;
                    
                    // Re-initialize icons and render charts
                    lucide.createIcons();
                    this.renderCharts(data);

                } else if (pageId === 'ai_report' || pageId === 'ai_consult') {
                    // Directly open modal and stay on dashboard
                    this.openAiModal(isHQ ? 'hq' : 'partner');
                    this.renderMainContent('dashboard');
                } else {
                    // Placeholder for other pages
                    content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-[60vh] text-slate-500 animate-fade-in">
                        <div class="bg-slate-900 p-6 rounded-full mb-4 border border-slate-800">
                            <i data-lucide="settings" class="w-12 h-12 text-slate-700"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-300 mb-2">í˜ì´ì§€ ì¤€ë¹„ ì¤‘</h2>
                        <p>í•´ë‹¹ ë©”ë‰´ëŠ” í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.</p>
                        <button onclick="app.renderMainContent('dashboard')" class="mt-6 text-blue-500 hover:underline flex items-center gap-2">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>`;
                    lucide.createIcons();
                }
            },

            createKpiCard: function(title, value, trend, icon, color) {
                const trendColor = trend >= 0 ? 'text-emerald-400' : 'text-red-400';
                const arrowIcon = trend >= 0 ? 'trending-up' : 'trending-down';
                const bgColors = { 
                    blue: 'bg-blue-500/10 text-blue-400', 
                    green: 'bg-emerald-500/10 text-emerald-400', 
                    purple: 'bg-purple-500/10 text-purple-400', 
                    amber: 'bg-amber-500/10 text-amber-400' 
                };
                
                return `
                <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-sm hover:shadow-md transition-shadow group">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">${title}</p>
                            <h3 class="text-2xl font-bold text-white">${value}</h3>
                        </div>
                        <div class="p-3 rounded-lg ${bgColors[color]} transition-colors">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="flex items-center font-medium ${trendColor}">
                            ${trend > 0 ? '+' : ''}${trend}% <i data-lucide="${arrowIcon}" class="w-4 h-4 ml-1"></i>
                        </span>
                        <span class="text-slate-500 ml-2">vs ì§€ë‚œì£¼</span>
                    </div>
                </div>`;
            },

            renderCharts: function(data) {
                if(!document.querySelector("#chart-sales")) return;

                // Sales Area Chart
                const optionsSales = {
                    series: [{ name: 'ë§¤ì¶œ', data: data.dailySales }],
                    chart: { type: 'area', height: 280, toolbar: { show: false }, background: 'transparent', fontFamily: 'Pretendard' },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    xaxis: { 
                        categories: data.dates, 
                        labels: { style: { colors: '#94a3b8' } }, 
                        axisBorder: { show: false }, 
                        axisTicks: { show: false } 
                    },
                    yaxis: { 
                        labels: { style: { colors: '#94a3b8' }, formatter: val => (val/10000) + 'ë§Œ' } 
                    },
                    grid: { borderColor: '#334155', strokeDashArray: 4 },
                    theme: { mode: 'dark' },
                    colors: ['#3b82f6'],
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } }
                };
                
                // Channel Donut Chart
                const optionsChannel = {
                    series: data.channelMix,
                    labels: ['í™€', 'ë°°ë‹¬'],
                    chart: { type: 'donut', height: 280, background: 'transparent', fontFamily: 'Pretendard' },
                    colors: ['#3b82f6', '#f59e0b'],
                    legend: { position: 'bottom', labels: { colors: '#e2e8f0' } },
                    stroke: { show: false },
                    dataLabels: { enabled: true, dropShadow: { enabled: false } },
                    plotOptions: {
                        pie: { donut: { labels: { show: true, total: { show: true, label: 'í™€ ë¹„ì¤‘', color: '#94a3b8', formatter: () => data.channelMix[0] + '%' } } } }
                    }
                };

                new ApexCharts(document.querySelector("#chart-sales"), optionsSales).render();
                new ApexCharts(document.querySelector("#chart-channel"), optionsChannel).render();
            },

            // --- Features ---
            toggleSidebar: function() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },

            updateCoinDisplay: function() {
                document.getElementById('coin-balance').innerText = this.coins;
            },

            openAdModal: function() {
                const modal = document.getElementById('modal-ad');
                modal.classList.remove('hidden-force');
                
                let progress = 0;
                const bar = document.getElementById('ad-progress');
                const btn = document.getElementById('ad-btn');
                
                // Reset state
                bar.style.width = '0%';
                btn.disabled = true;
                btn.innerText = 'ì‹œì²­ ì¤‘...';
                btn.className = 'w-full py-3 rounded-xl font-bold bg-slate-200 text-slate-400 transition-colors cursor-not-allowed';

                const interval = setInterval(() => {
                    progress += 2;
                    bar.style.width = progress + '%';
                    if(progress >= 100) {
                        clearInterval(interval);
                        btn.disabled = false;
                        btn.className = 'w-full py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-500 transition-colors';
                        btn.innerText = 'ë³´ìƒ ë°›ê¸° (+10 Coin)';
                    }
                }, 50);
            },

            completeAd: function() {
                this.coins += 10;
                this.updateCoinDisplay();
                document.getElementById('modal-ad').classList.add('hidden-force');
            },

            // --- AI Logic ---
            openAiModal: function(type) {
                const modal = document.getElementById('modal-ai');
                const content = document.getElementById('ai-modal-content');
                const title = document.getElementById('ai-modal-title');
                
                modal.classList.remove('hidden-force');
                title.innerText = type === 'hq' ? 'ì£¼ê°„ íšŒì˜ ìë£Œ ìƒì„± (5ì½”ì¸)' : 'ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸ ìƒì„± (1ì½”ì¸)';
                
                // Default State
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center min-h-[400px]">
                        <div class="w-20 h-20 bg-blue-600/20 rounded-full flex items-center justify-center mb-6 animate-bounce">
                            <i data-lucide="sparkles" class="w-10 h-10 text-blue-400"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-white mb-2">AI ë¦¬í¬íŠ¸ ìƒì„±</h4>
                        <p class="text-slate-400 mb-8">
                            ìµœì‹  ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ê°€ ë‹´ê¸´ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.<br/>
                            ì†Œìš” ë¹„ìš©: <span class="text-amber-400 font-bold">${type === 'hq' ? 5 : 1} ì½”ì¸</span>
                        </p>
                        <button onclick="app.generateReport('${type}')" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-900/20 flex items-center gap-2 transition-all">
                            <i data-lucide="coins" class="w-4 h-4 text-amber-300"></i> ìƒì„±í•˜ê¸°
                        </button>
                    </div>
                `;
                lucide.createIcons();
            },

            closeModal: function(id) {
                document.getElementById(id).classList.add('hidden-force');
            },

            generateReport: async function(type) {
                const cost = type === 'hq' ? 5 : 1;
                if(this.coins < cost) {
                    alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìƒë‹¨ [ì¶©ì „] ë²„íŠ¼ì„ ëˆŒëŸ¬ ê´‘ê³ ë¥¼ ì‹œì²­í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                this.coins -= cost;
                this.updateCoinDisplay();

                const content = document.getElementById('ai-modal-content');
                content.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center gap-4 min-h-[400px]">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                        <p class="text-slate-300 animate-pulse">Gemini AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <div class="text-xs text-slate-500">ë§¤ì¶œ ë¶„ì„ ì¤‘... OKR ëŒ€ì¡° ì¤‘...</div>
                    </div>
                `;

                const prompt = type === 'hq' 
                  ? `[ì—­í• ] F&B í”„ëœì°¨ì´ì¦ˆ COO. [ë°ì´í„°] ${JSON.stringify(DB.gangnam)}. [ë¬¸ë§¥] ${DB.okr}. [ìš”ì²­] ì£¼ê°„ íšŒì˜ìš© ë¦¬í¬íŠ¸(ê²°ì •ì‚¬í•­, ì´ìŠˆ, ì•¡ì…˜ì•„ì´í…œ)ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±. ì¤‘ìš” ìˆ˜ì¹˜ëŠ” ë³¼ë“œì²˜ë¦¬.`
                  : `[ì—­í• ] ìŠˆí¼ë°”ì´ì €. [ë°ì´í„°] ${JSON.stringify(DB.gangnam)}. [ìš”ì²­] ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸(ë§¤ì¶œë¶„ì„, ë©”ë‰´ì œì–¸, ìš´ì˜ì²´í¬ë¦¬ìŠ¤íŠ¸)ë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±. ê¸ì •ì ì´ê³  êµ¬ì²´ì ìœ¼ë¡œ.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨.";
                    
                    // Markdown Formatter
                    const formattedHTML = text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>')
                        .replace(/## (.*?)(<br>|$)/g, '<h3 class="text-xl font-bold text-blue-400 mt-8 mb-3 border-b border-slate-700 pb-2">$1</h3>')
                        .replace(/- /g, 'â€¢ ');

                    content.innerHTML = `
                        <div class="prose prose-invert max-w-none">
                            <div class="bg-slate-800/50 p-8 rounded-xl border border-slate-700 leading-relaxed text-slate-300 shadow-inner">
                                ${formattedHTML}
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3 sticky bottom-0 bg-slate-900 py-4 border-t border-slate-800">
                            <button onclick="app.openAiModal('${type}')" class="px-4 py-2 text-slate-400 hover:text-white transition-colors">ë‹¤ì‹œ ìƒì„±</button>
                            <button class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-500 shadow-lg flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> PDF ì €ì¥
                            </button>
                        </div>
                    `;
                    lucide.createIcons();

                } catch(e) {
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full min-h-[300px]">
                            <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mb-4"></i>
                            <p class="text-red-400 text-center font-bold mb-2">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                            <p class="text-slate-500 text-sm mb-6">${e.message}</p>
                            <button onclick="app.openAiModal('${type}')" class="bg-slate-800 px-4 py-2 rounded-lg hover:bg-slate-700">ëŒì•„ê°€ê¸°</button>
                        </div>
                    `;
                    lucide.createIcons();
                }
            },

            // --- Chat Bot ---
            toggleChat: function() {
                const chat = document.getElementById('chat-window');
                if (chat.classList.contains('hidden-force')) {
                    chat.classList.remove('hidden-force');
                } else {
                    chat.classList.add('hidden-force');
                }
            },

            sendChatMessage: async function() {
                const input = document.getElementById('chat-input');
                const msg = input.value;
                if(!msg.trim()) return;

                const container = document.getElementById('chat-messages');
                container.innerHTML += `
                    <div class="flex justify-end animate-fade-in">
                        <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[85%] shadow-md mb-2">
                            ${msg}
                        </div>
                    </div>
                `;
                input.value = '';
                container.scrollTop = container.scrollHeight;

                // Loading Bubble
                const loadingId = 'loading-' + Date.now();
                container.innerHTML += `
                    <div id="${loadingId}" class="flex justify-start animate-pulse">
                        <div class="bg-slate-800 p-3 rounded-2xl rounded-tl-none border border-slate-700 text-xs text-slate-400">
                            ì…ë ¥ ì¤‘...
                        </div>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `[ì‹œìŠ¤í…œ] ë‹¹ì‹ ì€ RestoGenie AIì…ë‹ˆë‹¤. ì‚¬ìš©ì ìœ í˜•: ${this.userType}. ë‹¤ìŒ ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”: ${JSON.stringify(DB.gangnam)}. ì§ˆë¬¸: ${msg}` }] }]
                        })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    
                    document.getElementById(loadingId).remove();
                    
                    container.innerHTML += `
                        <div class="flex justify-start animate-fade-in">
                            <div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none border border-slate-700 text-sm max-w-[85%] shadow-sm mb-2 leading-relaxed">
                                ${text}
                            </div>
                        </div>
                    `;
                } catch(e) {
                    document.getElementById(loadingId).innerHTML = `<span class="text-red-400">ì „ì†¡ ì‹¤íŒ¨</span>`;
                }
                container.scrollTop = container.scrollHeight;
            }
        };

        // Start App when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
