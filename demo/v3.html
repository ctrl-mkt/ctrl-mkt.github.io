<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie V7.0 (CSV & AI Integrated)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* File Upload Zone */
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; }
        .drop-zone.active { border-color: #2563eb; background-color: #eff6ff; }

        /* Sidebar */
        .sidebar-item { transition: all 0.2s; border-radius: 0.5rem; }
        .sidebar-item.active { background-color: #2563eb; color: white; font-weight: 600; }
        
        /* Chatbot */
        .chat-window { transition: transform 0.3s ease, opacity 0.3s ease; transform-origin: bottom right; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { 
            LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            PieChart, Pie, Cell, AreaChart, Area, FunnelChart, Funnel, LabelList 
        } = window.Recharts;

        // [GEMINI API KEY] - In production, use backend proxy
        // * Demo purpose only *
        const GEMINI_API_KEY = ""; // API Key는 환경변수나 사용자 입력으로 받는 것이 안전함

        const THEME = {
            primary: '#1e3a8a', secondary: '#2563eb', accent: '#60a5fa', 
            success: '#10b981', warning: '#f59e0b', danger: '#ef4444'
        };

        // --- Icons ---
        const Icons = {
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            File: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Bot: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="10" x="3" y="11" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" x2="8" y1="16" y2="16"/><line x1="16" x2="16" y1="16" y2="16"/></svg>,
            Home: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            PieChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        };

        // --- Data Utils ---
        const parseMoney = (v) => parseInt(String(v).replace(/[^0-9-]/g, '')) || 0;
        const parseDate = (v) => {
            if(!v) return null;
            const s = String(v);
            if (s.match(/^\d{4}-\d{2}-\d{2}/)) return s.substring(0,10);
            return null;
        };

        // --- Gemini AI Service ---
        const generateAI = async (prompt, apiKey) => {
            if (!apiKey) return "API Key가 설정되지 않았습니다. 우측 상단 설정에서 Key를 입력해주세요.";
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI 응답 생성 실패";
            } catch (e) {
                return `Error: ${e.message}`;
            }
        };

        // --- Main Component ---
        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [apiKey, setApiKey] = useState(GEMINI_API_KEY);
            
            // Data Store (Local)
            const [db, setDb] = useState({
                gangnam_sales: [],
                gangnam_menu: [],
                daehakro_sales: [],
                daehakro_menu: [],
                cctv: []
            });
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            
            // UI State
            const [mode, setMode] = useState('PARTNER');
            const [activeMenu, setActiveMenu] = useState('dashboard');
            const [selectedStore, setSelectedStore] = useState('gangnam');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatLogs, setChatLogs] = useState([{role: 'ai', text: '안녕하세요! CSV 데이터를 업로드하면 분석을 시작합니다.'}]);
            const [chatInput, setChatInput] = useState("");
            const [reportContent, setReportContent] = useState("");
            const [isProcessing, setIsProcessing] = useState(false);

            // --- File Upload Handler ---
            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                setIsProcessing(true);

                let newDb = { ...db };
                let processedCount = 0;

                files.forEach(file => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => {
                            const data = res.data;
                            const fileName = file.name;
                            const headerKeys = Object.keys(data[0] || {}).join(",").toLowerCase();

                            // Smart Classification based on filename or headers
                            if (fileName.includes("강남") && fileName.includes("Sales")) newDb.gangnam_sales = data;
                            else if (fileName.includes("대학로") && fileName.includes("Sales")) newDb.daehakro_sales = data;
                            else if (fileName.includes("강남") && fileName.includes("메뉴")) newDb.gangnam_menu = data;
                            else if (fileName.includes("대학로") && fileName.includes("메뉴")) newDb.daehakro_menu = data;
                            else if (fileName.includes("CCTV")) newDb.cctv = data;
                            else if (headerKeys.includes("business_date") || headerKeys.includes("영업일")) {
                                // Fallback: Guess by content if filename is ambiguous
                                // Assuming Gangnam for demo if unknown
                                newDb.gangnam_sales = data; 
                            }

                            processedCount++;
                            if (processedCount === files.length) {
                                setDb(newDb);
                                setIsDataLoaded(true);
                                setIsProcessing(false);
                                alert(`${files.length}개 파일 로드 완료! 대시보드가 갱신되었습니다.`);
                            }
                        }
                    });
                });
            };

            // --- AI Report Generator ---
            const generateReport = async (type) => {
                setIsProcessing(true);
                
                // Prepare Context Data (Summarized)
                const currentSales = (selectedStore === 'gangnam' ? db.gangnam_sales : db.daehakro_sales);
                const totalSales = currentSales.reduce((acc, r) => acc + parseMoney(r['결제 금액'] || r['sale_amt'] || 0), 0);
                const totalOrders = currentSales.length;
                const summary = `
                    매장: ${selectedStore}
                    총 매출: ${totalSales}원
                    총 주문수: ${totalOrders}건
                    데이터 기간: ${currentSales.length > 0 ? currentSales[0]['영업일'] : 'N/A'} ~ 
                `;

                const prompt = type === 'weekly' 
                    ? `다음 데이터를 기반으로 '주간 회의록'을 작성해줘. \n${summary}\n\n[형식]\n1. 매출 요약\n2. 주요 이슈\n3. 액션 아이템`
                    : `다음 데이터를 기반으로 '가맹점주 미팅 아젠다'를 작성해줘. \n${summary}\n\n[형식]\n1. 성과 분석\n2. 제안 사항\n3. Q&A`;

                const result = await generateAI(prompt, apiKey);
                setReportContent(result);
                setIsProcessing(false);
            };

            // --- Chatbot Handler ---
            const sendChat = async () => {
                if(!chatInput.trim()) return;
                const userMsg = chatInput;
                setChatLogs(prev => [...prev, { role: 'user', text: userMsg }]);
                setChatInput("");

                // Context injection
                const context = `현재 로딩된 데이터 요약: 강남점 매출 데이터 ${db.gangnam_sales.length}건, 대학로점 ${db.daehakro_sales.length}건.`;
                const systemPrompt = `너는 레스토지니 AI 비서야. 다음 데이터를 참고해서 답변해: ${context}`;
                
                const reply = await generateAI(`${systemPrompt}\n사용자 질문: ${userMsg}`, apiKey);
                setChatLogs(prev => [...prev, { role: 'ai', text: reply }]);
            };

            // --- Derived Data for Charts ---
            const getChartData = () => {
                const raw = (selectedStore === 'gangnam' ? db.gangnam_sales : db.daehakro_sales) || [];
                // Aggregate by Date
                const agg = {};
                raw.forEach(row => {
                    const date = parseDate(row['영업일'] || row['business_date']);
                    if (!date) return;
                    const amt = parseMoney(row['결제 금액'] || row['sale_amt'] || row['total_amt']);
                    
                    if (!agg[date]) agg[date] = { date, sales: 0, orders: 0 };
                    agg[date].sales += amt;
                    agg[date].orders += 1;
                });
                return Object.values(agg).sort((a,b) => a.date.localeCompare(b.date));
            };

            const chartData = getChartData();
            const totalSales = chartData.reduce((acc, r) => acc + r.sales, 0);

            // Render
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 font-[Pretendard]">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                             <div className="bg-blue-100 p-4 rounded-full inline-block mb-4"><Icons.Zap className="w-8 h-8 text-blue-600"/></div>
                             <h1 className="text-2xl font-bold mb-2">RestoGenie V7.0</h1>
                             <p className="text-slate-500 mb-6 text-sm">AI & CSV Integrated Dashboard</p>
                             <input type="password" placeholder="Gemini API Key (Optional)" className="w-full p-3 border rounded mb-4 text-sm" onChange={(e)=>setApiKey(e.target.value)} />
                             <button onClick={()=>setIsLoggedIn(true)} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Start Demo</button>
                        </div>
                    </div>
                )
            }

            return (
                <div className="flex h-screen bg-slate-50 font-[Pretendard] overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`bg-slate-900 text-white flex-shrink-0 transition-all ${sidebarOpen ? 'w-64' : 'w-20'} flex flex-col`}>
                        <div className="h-16 flex items-center justify-center border-b border-slate-800 cursor-pointer" onClick={()=>setSidebarOpen(!sidebarOpen)}>
                            <div className="flex items-center gap-2">
                                <Icons.Zap className="w-6 h-6 text-blue-500"/>
                                {sidebarOpen && <span className="font-bold text-lg">RestoGenie</span>}
                            </div>
                        </div>
                        <div className="flex-1 p-3 space-y-1">
                            <button onClick={()=>setActiveMenu('dashboard')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${activeMenu==='dashboard'?'bg-blue-600':'hover:bg-slate-800'}`}>
                                <Icons.Home className="w-5 h-5"/> {sidebarOpen && "대시보드"}
                            </button>
                            <button onClick={()=>setActiveMenu('report')} className={`w-full flex items-center gap-3 p-3 rounded-lg ${activeMenu==='report'?'bg-blue-600':'hover:bg-slate-800'}`}>
                                <Icons.File className="w-5 h-5"/> {sidebarOpen && "AI 리포트 센터"}
                            </button>
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6">
                            <h2 className="font-bold text-xl">{activeMenu === 'dashboard' ? '매장 대시보드' : 'AI 리포트'}</h2>
                            
                            <div className="flex items-center gap-4">
                                {/* CSV Uploader */}
                                <label className="flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100 border border-green-200">
                                    <Icons.Upload className="w-4 h-4"/>
                                    <span className="text-sm font-bold">CSV 데이터 업로드</span>
                                    <input type="file" multiple accept=".csv" className="hidden" onChange={handleFileUpload}/>
                                </label>
                                
                                <select value={selectedStore} onChange={(e)=>setSelectedStore(e.target.value)} className="bg-slate-100 border rounded px-3 py-2 text-sm font-bold outline-none">
                                    <option value="gangnam">강남점</option>
                                    <option value="daehakro">대학로점</option>
                                </select>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6">
                            {!isDataLoaded ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-300 rounded-xl m-4">
                                    <Icons.Upload className="w-16 h-16 mb-4 opacity-50"/>
                                    <p className="text-lg font-bold mb-2">데이터가 없습니다.</p>
                                    <p className="text-sm">우측 상단 'CSV 업로드' 버튼을 눌러<br/>강남/대학로 매출 파일을 업로드해주세요.</p>
                                </div>
                            ) : (
                                <>
                                    {/* Dashboard View */}
                                    {activeMenu === 'dashboard' && (
                                        <div className="space-y-6 animate-fade-in">
                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                <div className="bg-white p-6 rounded-xl shadow-sm border">
                                                    <p className="text-sm text-slate-500 mb-1">총 매출</p>
                                                    <p className="text-2xl font-bold">₩{totalSales.toLocaleString()}</p>
                                                </div>
                                                <div className="bg-white p-6 rounded-xl shadow-sm border">
                                                    <p className="text-sm text-slate-500 mb-1">총 주문수</p>
                                                    <p className="text-2xl font-bold">{chartData.reduce((a,b)=>a+b.orders,0).toLocaleString()}건</p>
                                                </div>
                                            </div>

                                            <div className="bg-white p-6 rounded-xl shadow-sm border h-80">
                                                <h3 className="font-bold mb-4">일별 매출 추이</h3>
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <AreaChart data={chartData}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                                        <XAxis dataKey="date" tick={{fontSize:12}}/>
                                                        <YAxis tick={{fontSize:12}}/>
                                                        <Tooltip formatter={(value) => `₩${value.toLocaleString()}`}/>
                                                        <Area type="monotone" dataKey="sales" stroke="#2563eb" fill="#dbeafe"/>
                                                    </AreaChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    )}

                                    {/* Report View */}
                                    {activeMenu === 'report' && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                                            <div className="space-y-4">
                                                <button onClick={()=>generateReport('weekly')} className="w-full p-6 bg-white border rounded-xl text-left hover:border-blue-500 transition shadow-sm group">
                                                    <h3 className="font-bold text-lg group-hover:text-blue-600">주간 회의 리포트 생성</h3>
                                                    <p className="text-sm text-slate-500 mt-2">현재 로딩된 매출 데이터를 분석하여 회의록 초안 작성</p>
                                                </button>
                                                <button onClick={()=>generateReport('meeting')} className="w-full p-6 bg-white border rounded-xl text-left hover:border-green-500 transition shadow-sm group">
                                                    <h3 className="font-bold text-lg group-hover:text-green-600">점주 미팅 아젠다 생성</h3>
                                                    <p className="text-sm text-slate-500 mt-2">매장 성과 분석 및 제안 사항 생성</p>
                                                </button>
                                            </div>
                                            
                                            <div className="bg-white p-6 rounded-xl border shadow-sm min-h-[400px] overflow-y-auto whitespace-pre-wrap text-sm leading-relaxed">
                                                {isProcessing ? (
                                                    <div className="flex items-center justify-center h-full gap-2 text-slate-500">
                                                        <div className="spinner"></div> Gemini AI가 분석 중입니다...
                                                    </div>
                                                ) : (
                                                    reportContent || "리포트 생성 버튼을 클릭하세요."
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                        
                        {/* Chatbot Overlay */}
                        <div className={`fixed bottom-6 right-6 w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden transition-all ${isChatOpen ? 'h-[500px] opacity-100' : 'h-0 opacity-0 overflow-hidden pointer-events-none'}`}>
                             <div className="bg-slate-800 p-4 text-white flex justify-between items-center">
                                 <span className="font-bold flex items-center gap-2"><Icons.Bot className="w-5 h-5"/> AI Copilot</span>
                                 <button onClick={()=>setIsChatOpen(false)}><Icons.X className="w-5 h-5"/></button>
                             </div>
                             <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                                 {chatLogs.map((msg, i) => (
                                     <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                         <div className={`max-w-[85%] p-3 rounded-xl text-sm ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border'}`}>{msg.text}</div>
                                     </div>
                                 ))}
                             </div>
                             <div className="p-3 bg-white border-t flex gap-2">
                                 <input className="flex-1 border rounded-full px-4 py-2 text-sm outline-none" value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&sendChat()} placeholder="질문하기..."/>
                                 <button onClick={sendChat} className="bg-blue-600 text-white p-2 rounded-full"><Icons.ChevronRight className="w-4 h-4"/></button>
                             </div>
                        </div>
                        {!isChatOpen && (
                            <button onClick={()=>setIsChatOpen(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-xl flex items-center justify-center">
                                <Icons.MessageSquare className="w-6 h-6"/>
                            </button>
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
