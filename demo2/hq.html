<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie HQ - Dashboard</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Pretendard', 'sans-serif'] },
                    colors: { 
                        navy: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' }, 
                        blue: { 500: '#3b82f6', 600: '#2563eb' },
                        gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 500: '#6b7280', 800: '#1f2937' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20">
        <div class="p-6 flex items-center gap-2 cursor-pointer border-b border-gray-100" onclick="location.href='hq.html'">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">R</div>
            <span class="text-xl font-bold text-navy-900">Resto Genie</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <div class="text-xs font-bold text-gray-400 mb-2 px-3">MAIN</div>
            <a href="hq.html" class="flex items-center px-3 py-2.5 bg-blue-50 text-blue-600 rounded-lg transition font-medium">
                <i class="ph ph-house text-lg mr-3"></i>홈 (대시보드)
            </a>
            <a href="hq/ai_center.html" class="flex items-center px-3 py-2.5 text-gray-600 hover:bg-gray-50 hover:text-navy-900 rounded-lg transition font-medium">
                <i class="ph ph-brain text-lg mr-3"></i>AI 리포트 센터
            </a>

            <div class="text-xs font-bold text-gray-400 mt-6 mb-2 px-3">ANALYTICS</div>
            <a href="hq/marketing.html" class="flex items-center px-3 py-2.5 text-gray-600 hover:bg-gray-50 hover:text-navy-900 rounded-lg transition font-medium">
                <i class="ph ph-megaphone text-lg mr-3"></i>마케팅 현황
            </a>
            <a href="hq/commercial.html" class="flex items-center px-3 py-2.5 text-gray-600 hover:bg-gray-50 hover:text-navy-900 rounded-lg transition font-medium">
                <i class="ph ph-map-pin text-lg mr-3"></i>상권 분석 (CCTV)
            </a>
            <a href="hq/store_mgmt.html" class="flex items-center px-3 py-2.5 text-gray-600 hover:bg-gray-50 hover:text-navy-900 rounded-lg transition font-medium">
                <i class="ph ph-store-front text-lg mr-3"></i>매장 운영 관리
            </a>
            <a href="hq/menu_cost.html" class="flex items-center px-3 py-2.5 text-gray-600 hover:bg-gray-50 hover:text-navy-900 rounded-lg transition font-medium">
                <i class="ph ph-hamburger text-lg mr-3"></i>메뉴/원가 현황
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <a href="index.html" class="flex items-center px-3 py-2 text-gray-500 hover:text-red-500 transition text-sm font-medium">
                <i class="ph ph-sign-out mr-2"></i> 로그아웃
            </a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-gray-50">
        <!-- TOP HEADER -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-lg font-bold text-navy-900">슬램버거 본사 (Slamburger HQ)</h2>
                <div class="h-4 w-px bg-gray-300"></div>
                <span class="text-sm text-gray-500">통합 대시보드 (OKR 연동)</span>
            </div>
            <div class="flex items-center gap-6">
                <div class="flex items-center bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium text-gray-600">
                    <i class="ph ph-calendar-blank mr-2"></i> Live Data
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-sm font-bold text-navy-900">관리자</div>
                        <div class="text-xs text-gray-500">HQ Admin</div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex items-center justify-center">
                        <i class="ph ph-user text-xl text-gray-500"></i>
                    </div>
                </div>
            </div>
        </header>

        <!-- SCROLLABLE DASHBOARD -->
        <div class="flex-1 overflow-y-auto p-8 space-y-6">
            
            <!-- Loading Indicator -->
            <div id="loading-overlay" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm">
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-navy-900 font-bold animate-pulse">OKR 데이터베이스 동기화 중...</p>
                </div>
            </div>

            <!-- 1. 5-Column KPI Cards -->
            <div class="grid grid-cols-5 gap-4">
                <!-- Card 1: 매출 -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-2">전사 총매출</div>
                    <div class="text-2xl font-bold text-navy-900 tracking-tight" id="total-sales">-</div>
                    <div class="flex items-center mt-2 text-xs text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded w-fit">
                        <span id="sales-wow">실시간 집계</span>
                    </div>
                </div>
                <!-- Card 2: 주문건수 -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-2">총 주문건수</div>
                    <div class="text-2xl font-bold text-navy-900 tracking-tight" id="total-orders">-</div>
                    <div class="flex items-center mt-2 text-xs text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded w-fit">
                        <span>실시간 집계</span>
                    </div>
                </div>
                <!-- Card 3: 건단가 -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-2">평균 객단가</div>
                    <div class="text-2xl font-bold text-navy-900 tracking-tight" id="avg-ticket">-</div>
                    <div class="flex items-center mt-2 text-xs text-red-500 bg-red-50 px-1.5 py-0.5 rounded w-fit">
                        <span id="ticket-wow">분석 중</span>
                    </div>
                </div>
                <!-- Card 4: 상품원가 (추정) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-2">총 상품원가 (Est.)</div>
                    <div class="text-2xl font-bold text-navy-900 tracking-tight" id="total-cogs">-</div>
                    <div class="flex items-center mt-2 text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded w-fit">
                        <span>원가율 약 35% 적용</span>
                    </div>
                </div>
                <!-- Card 5: 광고비 (추정) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-2">총 광고비 (Est.)</div>
                    <div class="text-2xl font-bold text-navy-900 tracking-tight" id="total-ad">-</div>
                    <div class="flex items-center mt-2 text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded w-fit">
                        <span>매출 대비 약 8%</span>
                    </div>
                </div>
            </div>

            <!-- 2. Charts Section -->
            <div class="grid grid-cols-12 gap-6">
                <!-- Left: Sales Trend -->
                <div class="col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-navy-900">전사 일별 매출 추이</h3>
                        <div class="flex gap-2">
                            <span class="text-xs text-gray-400">* 최근 30일 데이터</span>
                        </div>
                    </div>
                    <div class="h-72 w-full">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <!-- Right: Channel Mix -->
                <div class="col-span-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-navy-900">채널별 매출 비중</h3>
                    </div>
                    <div class="h-60 w-full relative flex justify-center">
                        <canvas id="channelChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-xs text-gray-400">Total</span>
                            <span class="text-lg font-bold text-navy-900" id="donut-total">-</span>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2" id="channel-legend">
                        <!-- Legend Injected by JS -->
                    </div>
                </div>
            </div>

            <!-- 3. TOP Sales Stores Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-navy-900">실시간 매장 매출 순위</h3>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <th class="px-6 py-4 font-semibold w-16 text-center">순위</th>
                            <th class="px-6 py-4 font-semibold">매장명</th>
                            <th class="px-6 py-4 font-semibold text-right">매출액</th>
                            <th class="px-6 py-4 font-semibold text-right">주문수</th>
                            <th class="px-6 py-4 font-semibold text-right">객단가</th>
                            <th class="px-6 py-4 font-semibold text-center">상태</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 text-sm" id="store-rank-body">
                        <tr><td colspan="6" class="text-center py-8 text-gray-400">데이터를 불러오는 중입니다...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Chatbot Floating Button -->
        <div class="absolute bottom-8 right-8 z-50">
            <button onclick="document.getElementById('chatbot-modal').classList.toggle('hidden')" class="bg-navy-900 hover:bg-blue-600 text-white p-4 rounded-full shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 flex items-center justify-center">
                <i class="ph ph-sparkle text-2xl"></i>
            </button>
        </div>

        <!-- Chatbot Modal -->
        <div id="chatbot-modal" class="hidden absolute bottom-24 right-8 w-[400px] h-[600px] bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col z-50 overflow-hidden ring-1 ring-black/5">
            <div class="bg-navy-900 p-4 text-white font-bold flex justify-between items-center">
                <div class="flex items-center gap-2"><i class="ph ph-robot"></i> RestoGenie AI (OKR)</div>
                <button onclick="document.getElementById('chatbot-modal').classList.add('hidden')" class="hover:text-gray-300"><i class="ph ph-x"></i></button>
            </div>
            <div class="flex-1 p-4 bg-gray-50 overflow-y-auto space-y-4" id="chat-history">
                <div class="flex gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0"><i class="ph ph-robot"></i></div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 text-gray-700">
                        안녕하세요! <b>컨트롤엠 OKR 대시보드</b> 데이터베이스와 연동되었습니다.<br>
                        전사 매출, 매장별 이슈, OKR 달성 현황에 대해 물어보세요.
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-gray-100">
                <div class="relative">
                    <input type="text" id="chat-input" class="w-full bg-gray-100 rounded-full pl-4 pr-12 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="예: 이번 달 OKR 달성 현황 알려줘">
                    <button class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-blue-600 hover:text-blue-800"><i class="ph ph-paper-plane-right text-lg"></i></button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG & DATA SOURCES ---
        const URLS = {
            okr: 'https://script.google.com/macros/s/AKfycbyjkoDkxQnubP8KscipgKm8HHAd_SmIShuhwPcrc2BrXu738N8Eq3hEoJSLGv5ZMuwZkA/exec', // NEW OKR DB
            gangnam: 'https://script.google.com/macros/s/AKfycbxr6BhzISGKFkFN2WV01WVimeyScO-EkmuCvLa7fW7UirzNW-GdFaZEjYxLFyzc8K-u/exec',
            daehakro: 'https://script.google.com/macros/s/AKfycbxjsm0CAv0MHXlMeMEbE6zYVOGPyelMsypLjCP7x-AY4pyihaAhYNkhVSHwfvJ8v9d7/exec'
        };

        // Global Data Store for AI Context
        let GLOBAL_AI_CONTEXT = {
            okr: null,
            sales: null
        };

        // Format Currency
        const fmt = (n) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(n);
        const fmtNum = (n) => new Intl.NumberFormat('ko-KR').format(n);

        // --- MAIN LOGIC ---
        async function initDashboard() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                // Fetch OKR Data + Store Data
                const [okrData, gData, dData] = await Promise.all([
                    fetch(URLS.okr).then(r => r.json()).catch(() => ({ error: 'OKR fetch failed' })),
                    fetch(URLS.gangnam).then(r => r.json()),
                    fetch(URLS.daehakro).then(r => r.json())
                ]);

                // Save to Global Context for Chatbot
                GLOBAL_AI_CONTEXT.okr = okrData;
                GLOBAL_AI_CONTEXT.sales = { gangnam: gData, daehakro: dData };

                // --- Process Sales Data for Dashboard ---
                const allSales = [...gData, ...dData];
                const totalSales = allSales.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                const realTotalOrders = allSales.reduce((sum, item) => sum + (Number(item.count) || 1), 0);
                const avgTicket = realTotalOrders > 0 ? Math.round(totalSales / realTotalOrders) : 0;

                // Update KPI Cards
                document.getElementById('total-sales').innerText = fmt(totalSales);
                document.getElementById('total-orders').innerText = fmtNum(realTotalOrders) + " 건";
                document.getElementById('avg-ticket').innerText = fmt(avgTicket);
                document.getElementById('total-cogs').innerText = fmt(Math.round(totalSales * 0.35)); 
                document.getElementById('total-ad').innerText = fmt(Math.round(totalSales * 0.08)); 

                // --- Store Ranking Table ---
                const gSales = gData.reduce((s, i) => s + (Number(i.amount)||0), 0);
                const dSales = dData.reduce((s, i) => s + (Number(i.amount)||0), 0);
                const gCount = gData.reduce((s, i) => s + (Number(i.count)||1), 0);
                const dCount = dData.reduce((s, i) => s + (Number(i.count)||1), 0);

                const stores = [
                    { name: '슬램버거 강남점', sales: gSales, count: gCount, ticket: gSales/gCount },
                    { name: '슬램버거 대학로점', sales: dSales, count: dCount, ticket: dSales/dCount }
                ].sort((a, b) => b.sales - a.sales);

                const tbody = document.getElementById('store-rank-body');
                tbody.innerHTML = stores.map((s, idx) => `
                    <tr class="hover:bg-blue-50/50 transition cursor-pointer">
                        <td class="px-6 py-4 text-center font-bold ${idx===0?'text-blue-600':'text-navy-900'}">${idx+1}</td>
                        <td class="px-6 py-4 font-bold text-navy-900">${s.name}</td>
                        <td class="px-6 py-4 text-right font-bold text-navy-900">${fmt(s.sales)}</td>
                        <td class="px-6 py-4 text-right text-gray-500">${fmtNum(s.count)}건</td>
                        <td class="px-6 py-4 text-right font-medium text-gray-700">${fmt(Math.round(s.ticket))}</td>
                        <td class="px-6 py-4 text-center"><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">영업중</span></td>
                    </tr>
                `).join('');

                renderSalesChart(allSales);
                renderChannelChart(allSales);

            } catch (e) {
                console.error(e);
                // Silent fail for demo, dashboard will show dashes
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function renderSalesChart(data) {
            const salesByDate = {};
            data.forEach(item => {
                const date = item.date ? item.date.split('T')[0] : 'Unknown';
                salesByDate[date] = (salesByDate[date] || 0) + (Number(item.amount) || 0);
            });
            const labels = Object.keys(salesByDate).sort().slice(-14);
            const values = labels.map(d => salesByDate[d]);

            new Chart(document.getElementById('salesTrendChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '전사 매출',
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderChannelChart(data) {
            const salesByChannel = {};
            let total = 0;
            data.forEach(item => {
                const ch = item.channel || '기타';
                const amt = Number(item.amount) || 0;
                salesByChannel[ch] = (salesByChannel[ch] || 0) + amt;
                total += amt;
            });
            document.getElementById('donut-total').innerText = (total / 100000000).toFixed(1) + "억";
            const labels = Object.keys(salesByChannel);
            const values = Object.values(salesByChannel);
            
            new Chart(document.getElementById('channelChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#3b82f6', '#22d3ee', '#94a3b8', '#fbbf24', '#f472b6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
            });

            const legendHTML = labels.map((l, i) => {
                const pct = Math.round((values[i] / total) * 100);
                const color = ['bg-blue-500', 'bg-cyan-400', 'bg-slate-400', 'bg-amber-400', 'bg-pink-400'][i % 5];
                return `
                    <div class="flex justify-between text-sm">
                        <span class="flex items-center"><span class="w-3 h-3 rounded-full ${color} mr-2"></span>${l}</span>
                        <span class="font-bold">${pct}%</span>
                    </div>
                `;
            }).join('');
            document.getElementById('channel-legend').innerHTML = legendHTML;
        }

        // Start
        initDashboard();

        // --- CHATBOT (Gemini 2.5 Flash with OKR Context) ---
        const GEMINI_API_KEY = "AIzaSyCILSrQKjRiupRcyNd1pFJUksNMkGVY8AQ";
        const MODEL = "gemini-2.5-flash-preview-09-2025";

        document.getElementById('chat-input').addEventListener('keypress', async (e) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                const userMsg = e.target.value;
                const history = document.getElementById('chat-history');
                
                history.innerHTML += `<div class="flex gap-2 flex-row-reverse"><div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none text-sm">${userMsg}</div></div>`;
                e.target.value = '';
                history.scrollTop = history.scrollHeight;

                const loadId = 'load-'+Date.now();
                history.innerHTML += `<div id="${loadId}" class="flex gap-2"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="ph ph-robot"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100"><div class="loader w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div></div>`;
                history.scrollTop = history.scrollHeight;

                try {
                    // Construct Context with OKR Data + Sales Summary
                    // If OKR data is large, we send a slice or summary. Here we send the raw object assuming reasonable size.
                    const aiContext = JSON.stringify({
                        OKR_Database: GLOBAL_AI_CONTEXT.okr,
                        Recent_Sales_Sample: {
                            gangnam: GLOBAL_AI_CONTEXT.sales?.gangnam?.slice(-3),
                            daehakro: GLOBAL_AI_CONTEXT.sales?.daehakro?.slice(-3)
                        }
                    }).substring(0, 50000); // Limit token usage

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: `System: You are RestoGenie AI. Use the provided 'OKR_Database' as the primary source of truth for Control M's objectives, key results, and status. Use 'Recent_Sales_Sample' for real-time numbers. Answer simply in Korean.\n\nContext Data: ${aiContext}\n\nUser Question: ${userMsg}` }] }] 
                        })
                    });
                    
                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "죄송합니다. 답변을 생성하지 못했습니다.";

                    document.getElementById(loadId).remove();
                    history.innerHTML += `<div class="flex gap-2"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="ph ph-robot"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 prose prose-sm">${marked.parse(aiText)}</div></div>`;
                    history.scrollTop = history.scrollHeight;

                } catch (err) {
                    document.getElementById(loadId).remove();
                    history.innerHTML += `<div class="flex gap-2"><div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="ph ph-warning"></i></div><div class="bg-white p-3 text-red-600 text-sm">오류: ${err.message}</div></div>`;
                }
            }
        });
    </script>
</body>
</html>
