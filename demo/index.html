<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie - í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <!-- Fonts -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-force { display: none !important; }
        /* Glassmorphism */
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { slate: { 850: '#172033', 900: '#0f172a', 950: '#020617' } }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-950 text-slate-200 overflow-hidden h-screen w-screen selection:bg-indigo-500/30">

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl mx-auto flex items-center justify-center mb-4 shadow-lg">
                    <i data-lucide="sparkles" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">RestoGenie</h1>
                <p class="text-slate-400">ë°ì´í„° ê¸°ë°˜ í†µí•© í”„ëœì°¨ì´ì¦ˆ ì†”ë£¨ì…˜</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="login-id" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì•„ì´ë””">
                <input type="password" id="login-pw" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button onclick="app.login()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-lg transition-all mt-2">ë¡œê·¸ì¸</button>
            </div>
            
            <div class="mt-8 grid grid-cols-2 gap-3 border-t border-slate-700 pt-6">
                <button onclick="app.fillLogin('demo', 'ctrlm2025!')" class="text-xs bg-slate-800 hover:bg-slate-700 py-3 rounded-lg border border-slate-600 text-slate-300 transition-colors flex flex-col items-center gap-1">
                    <span class="font-bold text-blue-400">HQ ë³¸ì‚¬</span>
                    <span>(demo)</span>
                </button>
                <button onclick="app.fillLogin('partner', 'ctrlm2025!')" class="text-xs bg-slate-800 hover:bg-slate-700 py-3 rounded-lg border border-slate-600 text-slate-300 transition-colors flex flex-col items-center gap-1">
                    <span class="font-bold text-indigo-400">Partner ì ì£¼</span>
                    <span>(partner)</span>
                </button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD LAYOUT -->
    <div id="dashboard-view" class="hidden-force flex h-full w-full">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300 absolute lg:relative h-full z-40 -translate-x-full lg:translate-x-0">
            <div class="h-16 flex items-center px-6 border-b border-slate-800 flex-shrink-0">
                <i id="logo-icon" data-lucide="layout-grid" class="text-indigo-500 w-6 h-6 mr-3"></i>
                <span id="logo-text" class="text-lg font-bold text-white tracking-tight">RestoGenie</span>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar">
                <div id="sidebar-menu">
                    <!-- Menu Injected Dynamically -->
                </div>
                
                <div id="ai-menu-section">
                    <!-- AI Menu Injected -->
                </div>
            </div>

            <div class="p-4 bg-slate-850 border-t border-slate-800 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div id="user-avatar" class="w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold text-white">User</div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-bold text-white">ì‚¬ìš©ì</p>
                        <p id="user-role" class="text-xs text-slate-400">ì§ì±…</p>
                    </div>
                    <button onclick="location.reload()" class="text-slate-500 hover:text-white"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden backdrop-blur-sm"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 bg-slate-950 h-full relative">
            
            <!-- Header -->
            <header class="h-16 bg-slate-900/90 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 lg:px-8 sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <button onclick="app.toggleSidebar()" class="lg:hidden text-slate-400"><i data-lucide="menu"></i></button>
                    <h2 id="page-title" class="text-lg font-bold text-white flex items-center gap-2">í™ˆ</h2>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Store Toggle (HQ Only) -->
                    <div id="store-selector-wrapper" class="hidden relative">
                        <select id="store-select" onchange="app.changeStore(this.value)" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg pl-4 pr-10 py-2 focus:border-blue-500 outline-none appearance-none cursor-pointer hover:bg-slate-700 transition-colors">
                            <option value="all">ì „ì‚¬ (HQ Total)</option>
                            <option value="gangnam">ì§ì˜ ê°•ë‚¨ì </option>
                            <option value="daehakro">ì§ì˜ ëŒ€í•™ë¡œì </option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                    </div>
                    
                    <!-- Partner Status (Partner Only) -->
                    <div id="partner-status-wrapper" class="hidden text-sm text-slate-400 hidden md:block">
                        <span class="text-indigo-400 font-bold">ê°•ë‚¨ì </span> ì˜ì—…ì¤‘ <span class="text-green-400 animate-pulse">â—</span>
                    </div>

                    <!-- Coins -->
                    <div onclick="app.openAdModal()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full border border-slate-700 cursor-pointer hover:border-amber-500/50 transition-colors group">
                        <i data-lucide="coins" class="w-4 h-4 text-amber-400 group-hover:scale-110 transition-transform"></i>
                        <span id="coin-disp" class="text-sm font-bold text-white">100</span>
                        <span class="text-[10px] bg-indigo-600 text-white px-1.5 py-0.5 rounded ml-1">ì¶©ì „</span>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main id="main-content" class="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar relative">
                <!-- Dynamic Content -->
            </main>

        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden-force fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass w-full max-w-3xl h-[80vh] rounded-2xl flex flex-col">
            <div class="h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-slate-800/50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-500/20 rounded-lg"><i data-lucide="sparkles" class="w-5 h-5 text-indigo-400"></i></div>
                    <h3 id="ai-modal-title" class="text-lg font-bold text-white">AI ë¦¬í¬íŠ¸</h3>
                </div>
                <button onclick="document.getElementById('ai-modal').classList.add('hidden-force')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-content-area" class="flex-1 overflow-y-auto p-6 custom-scrollbar text-slate-300 leading-relaxed"></div>
        </div>
    </div>

    <!-- Ad Modal -->
    <div id="ad-modal" class="hidden-force fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold text-slate-900 mb-4">ì½”ì¸ ì¶©ì „ì†Œ</h3>
            <div class="aspect-video bg-slate-100 rounded-xl mb-4 flex items-center justify-center"><i data-lucide="play-circle" class="w-12 h-12 text-slate-300"></i></div>
            <div class="h-2 bg-slate-200 rounded-full mb-4"><div id="ad-progress" class="h-full bg-indigo-600 w-0 transition-all duration-100"></div></div>
            <button id="ad-close-btn" disabled onclick="app.completeAd()" class="w-full py-3 rounded-lg font-bold bg-slate-200 text-slate-400 transition-colors">ê´‘ê³  ì‹œì²­ ì¤‘...</button>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div id="chat-box" class="hidden-force w-80 md:w-96 h-[500px] glass rounded-2xl shadow-2xl flex flex-col mb-4 overflow-hidden border-slate-700">
            <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700">
                <span class="text-white font-bold flex items-center gap-2"><i data-lucide="bot" class="w-5 h-5 text-indigo-400"></i> <span id="chat-title">AI Agent</span></span>
                <button onclick="document.getElementById('chat-box').classList.add('hidden-force')"><i data-lucide="x" class="w-5 h-5 text-white/80"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-slate-900/50">
                <div class="flex justify-start"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] border border-slate-700 shadow-sm">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div></div>
            </div>
            <div class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                <input id="chat-input" type="text" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.key==='Enter') app.sendMessage()">
                <button onclick="app.sendMessage()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-500 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
        <button onclick="document.getElementById('chat-box').classList.toggle('hidden-force')" class="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-xl transition-transform hover:scale-105 border-4 border-slate-900">
            <i data-lucide="message-square" class="w-6 h-6"></i>
        </button>
    </div>

    <script>
        // Config
        const GEMINI_KEY = "AIzaSyCILSrQKjRiupRcyNd1pFJUksNMkGVY8AQ"; 
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025"; 

        // Data Store
        const DB = {
            all: {
                name: "ì „ì‚¬ (HQ Total)",
                sales: { daily: [45000000, 42000000, 48000000, 46000000, 52000000, 55000000, 38000000], dates: ['11/10', '11/11', '11/12', '11/13', '11/14', '11/15', '11/16'], total: 326000000, channel: [60, 40] },
                issues: [{ store: "ì‹ ë‹¹ì ", type: "ë§¤ì¶œë¶€ì§„", desc: "ì£¼ë§ ë§¤ì¶œ ì „ì›” ëŒ€ë¹„ 15% í•˜ë½" }, { store: "ê°•ë‚¨ì ", type: "ì¬ê³ ì´ìŠˆ", desc: "ë¸Œë¦¬ì˜¤ìŠˆ ë²ˆ ì¬ê³  ë¶€ì¡± ê²½ê³ " }]
            },
            gangnam: {
                name: "ì§ì˜ ê°•ë‚¨ì ",
                sales: { 
                    daily: [1817700, 1546200, 1982900, 1602400, 2546200, 2897600, 1508700], 
                    dates: ['11/10(ì›”)', '11/11(í™”)', '11/12(ìˆ˜)', '11/13(ëª©)', '11/14(ê¸ˆ)', '11/15(í† )', '11/16(ì¼)'], 
                    total: 13899500, profit: 3474875, cost: 4864825, delivery: 2084925, fees: 3474875, channel: [55, 45] 
                },
                menus: [
                    { name: 'ë” í¬ë¦¬ìŠ¤í”¼ ê°ˆë¹„ ë²„ê±° SET', qty: 450, sales: 4365000, margin: 'High' },
                    { name: 'ë” ë¹„í”„ ë²„ê±° SET', qty: 380, sales: 3686000, margin: 'Mid' },
                    { name: 'ì¹˜ì¦ˆë²„ê±° SET', qty: 210, sales: 1869000, margin: 'Mid' },
                    { name: 'ë§¥ì•¤ì¹˜ì¦ˆ ë²„ê±°', qty: 150, sales: 1185000, margin: 'Low' }
                ],
                reviews: [
                    { user: 'ë§›ìˆìœ¼ë©´ì§–ëŠ”ê°œ', rating: 5, date: '2025-11-16', content: 'ê°ˆë¹„ë²„ê±° ì§„ì§œ ë¯¸ì³¤ë„¤ìš”.. ìœ¡ì¦™ ëŒ€ë°•ì…ë‹ˆë‹¤ ğŸ¶', reply: false },
                    { user: 'ë²„ê±°í‚¹ë§Œë¨¹ìŒ', rating: 4, date: '2025-11-15', content: 'ë§›ì€ ìˆëŠ”ë° ë°°ë‹¬ì´ ì¢€ ì‹ì–´ì„œ ì™”ì–´ìš”. í¬ì¥ì— ì‹ ê²½ì¨ì£¼ì„¸ìš”.', reply: true }
                ],
                issues: [{ store: "ê°•ë‚¨ì ", type: "ìš´ì˜", desc: "ëŸ°ì¹˜ íƒ€ì„ ì›¨ì´íŒ… 30ë¶„ ì´ˆê³¼ ë°œìƒ" }]
            },
            daehakro: {
                name: "ì§ì˜ ëŒ€í•™ë¡œì ",
                sales: { daily: [1750600, 1685000, 1840200, 1580000, 2100500, 2500000, 2500000], dates: ['11/10', '11/11', '11/12', '11/13', '11/14', '11/15', '11/16'], total: 13956300, channel: [40, 60] },
                issues: []
            },
            okr_context: `[2025-11-11 OKR íšŒì˜ë¡ ìš”ì•½]\n- ê²°ì •ì‚¬í•­: ê°•ë‚¨ì  ëŸ°ì¹˜ ë©”ë‰´ ë³€ê²½(11/12), ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì¿ í° ë°œê¸‰, B2B ë°ëª¨ ì·¨ì†Œ.\n- ê°•ë‚¨ì  ì´ìŠˆ: ë””ë„ˆ í¬ì¥ í• ì¸ ì¢…ë£Œ (ì‹¤íš¨ì„± ë‚®ìŒ).\n- ëª©í‘œ: 11ì›” ì „ì‚¬ ë§¤ì¶œ 2.7ì–µ ë‹¬ì„± (í˜„ì¬ 72% ë‹¬ì„±).`
        };

        const STORE_LIST = [
            { id: 'gangnam', name: 'ê°•ë‚¨ì ', owner: 'ë°•ìš”í•œ', status: 'OPEN', sales: '1.2ì–µ', rate: 94, risk: 'Low' },
            { id: 'daehakro', name: 'ëŒ€í•™ë¡œì ', owner: 'ì†Œì •ë¹ˆ', status: 'OPEN', sales: '1.1ì–µ', rate: 88, risk: 'Low' },
            { id: 'sindang', name: 'ì‹ ë‹¹ì ', owner: 'ê¹€ë§Œì œ', status: 'CLOSED', sales: '0.8ì–µ', rate: 72, risk: 'High' },
            { id: 'yeokgok', name: 'ì—­ê³¡ì ', owner: 'ì´ì¤€ìš©', status: 'OPEN', sales: '0.9ì–µ', rate: 85, risk: 'Medium' }
        ];

        const app = {
            userType: null, // 'hq' or 'partner'
            coins: 100,
            storeId: 'all', // Current selected store context
            
            init() {
                lucide.createIcons();
            },

            fillLogin(id, pw) {
                document.getElementById('login-id').value = id;
                document.getElementById('login-pw').value = pw;
            },

            login() {
                const id = document.getElementById('login-id').value;
                const pw = document.getElementById('login-pw').value;

                if (id === 'demo' && pw === 'ctrlm2025!') {
                    this.userType = 'hq';
                    this.storeId = 'all';
                    this.enterDashboard();
                } else if (id === 'partner' && pw === 'ctrlm2025!') {
                    this.userType = 'partner';
                    this.storeId = 'gangnam'; // Partners defaulted to their store
                    this.enterDashboard();
                } else {
                    alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            },

            enterDashboard() {
                document.getElementById('login-view').classList.add('hidden-force');
                document.getElementById('dashboard-view').classList.remove('hidden-force');
                this.updateUIByRole();
                this.renderSidebar();
                this.loadPage(this.userType === 'hq' ? 'dashboard' : 'home');
            },

            updateUIByRole() {
                const isHQ = this.userType === 'hq';
                
                // 1. User Profile
                document.getElementById('user-avatar').className = `w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold text-white ${isHQ ? 'bg-blue-600' : 'bg-indigo-600'}`;
                document.getElementById('user-avatar').innerText = isHQ ? 'HQ' : 'PT';
                document.getElementById('user-name').innerText = isHQ ? 'ê¹€ë„ìœ¤ íŒ€ì¥' : 'ë°•ìš”í•œ ì ì£¼';
                document.getElementById('user-role').innerText = isHQ ? 'ìš´ì˜ë³¸ë¶€' : 'ê°•ë‚¨ì ';
                
                // 2. Header Controls
                if (isHQ) {
                    document.getElementById('store-selector-wrapper').classList.remove('hidden');
                    document.getElementById('partner-status-wrapper').classList.add('hidden');
                    document.getElementById('logo-text').innerText = "RestoGenie HQ";
                    document.getElementById('logo-icon').className = "text-blue-500 w-6 h-6 mr-3";
                } else {
                    document.getElementById('store-selector-wrapper').classList.add('hidden');
                    document.getElementById('partner-status-wrapper').classList.remove('hidden');
                    document.getElementById('logo-text').innerText = "RestoGenie Partner";
                    document.getElementById('logo-icon').className = "text-indigo-500 w-6 h-6 mr-3";
                }
                
                // 3. Chat Title
                document.getElementById('chat-title').innerText = isHQ ? 'HQ Agent' : 'Partner Agent';
            },

            renderSidebar() {
                const menuContainer = document.getElementById('sidebar-menu');
                const aiContainer = document.getElementById('ai-menu-section');
                const isHQ = this.userType === 'hq';

                const menus = isHQ ? [
                    { id: 'dashboard', icon: 'layout-dashboard', label: 'ì¢…í•© ëŒ€ì‹œë³´ë“œ' },
                    { id: 'sales', icon: 'trending-up', label: 'ë§¤ì¶œ ë¶„ì„' },
                    { id: 'stores', icon: 'store', label: 'ê°€ë§¹ì  ê´€ë¦¬' }
                ] : [
                    { id: 'home', icon: 'layout-dashboard', label: 'ë‚´ ë§¤ì¥ í™ˆ' },
                    { id: 'sales', icon: 'dollar-sign', label: 'ë§¤ì¶œ/ì†ìµ' },
                    { id: 'menu', icon: 'shopping-bag', label: 'ë©”ë‰´ ë¶„ì„' },
                    { id: 'reviews', icon: 'message-square', label: 'ë¦¬ë·° ê´€ë¦¬' }
                ];

                const aiMenus = isHQ ? [
                    { id: 'ai_report', icon: 'file-text', label: 'AI ì£¼ê°„ íšŒì˜ë¡' }
                ] : [
                    { id: 'ai_consult', icon: 'clipboard-check', label: 'AI ë§¤ì¥ ì ê²€' }
                ];

                const renderBtn = (m) => `
                    <button onclick="app.loadPage('${m.id}')" id="btn-${m.id}" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all group">
                        <i data-lucide="${m.icon}" class="w-5 h-5 ${isHQ ? 'group-hover:text-blue-400' : 'group-hover:text-indigo-400'}"></i>
                        <span class="font-medium">${m.label}</span>
                    </button>`;

                menuContainer.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">Main Menu</div>` + menus.map(renderBtn).join('');
                aiContainer.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2 mt-6">AI Center</div>` + aiMenus.map(renderBtn).join('');
                
                lucide.createIcons();
            },

            changeStore(val) {
                this.storeId = val;
                const currentPage = document.querySelector('.bg-slate-800.text-white')?.id?.replace('btn-', '') || 'dashboard';
                this.loadPage(currentPage);
            },

            loadPage(pageId) {
                // 1. Active State Logic
                document.querySelectorAll('aside button').forEach(b => b.className = b.className.replace(/bg-slate-800 text-white/g, 'text-slate-400'));
                const btn = document.getElementById(`btn-${pageId}`);
                if(btn) btn.className = btn.className.replace('text-slate-400', 'bg-slate-800 text-white');

                // 2. Close mobile sidebar
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-overlay').classList.add('hidden');

                // 3. Content Injection
                const main = document.getElementById('main-content');
                const title = document.getElementById('page-title');
                const isHQ = this.userType === 'hq';
                const data = DB[this.storeId] || DB.all; // Fallback

                // Title Map
                const titles = { 
                    dashboard: 'ì¢…í•© ëŒ€ì‹œë³´ë“œ', sales: 'ë§¤ì¶œ ë¶„ì„', stores: 'ê°€ë§¹ì  ê´€ë¦¬', 
                    home: 'ë‚´ ë§¤ì¥ í™ˆ', menu: 'ë©”ë‰´ ë¶„ì„', reviews: 'ë¦¬ë·° ê´€ë¦¬',
                    ai_report: 'AI ë¦¬í¬íŠ¸ ìƒì„±', ai_consult: 'AI ë§¤ì¥ ì ê²€' 
                };
                title.innerText = titles[pageId] || pageId;

                // Routing
                if (isHQ) {
                    if(pageId === 'dashboard') { main.innerHTML = this.getHQDashboardHTML(data); this.renderChart(data.sales.daily, 'area', 'chart-main'); }
                    else if(pageId === 'sales') { main.innerHTML = this.getHQSalesHTML(data); this.renderChart(data.sales.channel, 'donut', 'chart-channel'); }
                    else if(pageId === 'stores') { main.innerHTML = this.getHQStoresHTML(); }
                    else if(pageId === 'ai_report') { this.openAiModal('hq'); }
                } else {
                    if(pageId === 'home') { main.innerHTML = this.getPartnerHomeHTML(); this.renderChart(DB.gangnam.sales.daily, 'area', 'chart-home'); }
                    else if(pageId === 'sales') { main.innerHTML = this.getPartnerSalesHTML(); }
                    else if(pageId === 'menu') { main.innerHTML = this.getPartnerMenuHTML(); }
                    else if(pageId === 'reviews') { main.innerHTML = this.getPartnerReviewsHTML(); }
                    else if(pageId === 'ai_consult') { this.openAiModal('partner'); }
                }
                
                lucide.createIcons();
            },

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            },

            // --- HTML Generators (HQ) ---
            getHQDashboardHTML(data) {
                return `
                    <div class="space-y-6 fade-in pb-20">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            ${this.kpiCard('ì´ ë§¤ì¶œ (11ì›”)', data.sales.total.toLocaleString()+'ì›', 12.5, 'dollar-sign', 'blue')}
                            ${this.kpiCard('ì£¼ë¬¸ ê±´ìˆ˜', '1,345ê±´', 8.2, 'shopping-bag', 'emerald')}
                            ${this.kpiCard('í‰ê·  ê°ë‹¨ê°€', '16,500ì›', 1.4, 'credit-card', 'purple')}
                            ${this.kpiCard('ë°°ë‹¬ ë¹„ì¤‘', data.sales.channel[1]+'%', -2.1, 'truck', 'amber')}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-slate-900 border border-slate-800 rounded-xl p-5 h-[350px]">
                                <h3 class="text-base font-bold text-white mb-4">ë§¤ì¶œ ì¶”ì´</h3>
                                <div id="chart-main" class="h-[280px]"></div>
                            </div>
                            <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 h-[350px] flex flex-col">
                                <h3 class="text-base font-bold text-white mb-4">ì´ìŠˆ ìš”ì•½</h3>
                                <div class="flex-1 space-y-3 overflow-y-auto custom-scrollbar">
                                    ${data.issues.map(i => `
                                        <div class="bg-slate-950 p-3 rounded-lg border border-slate-800 flex justify-between items-center">
                                            <div><span class="text-xs font-bold text-blue-400 bg-blue-400/10 px-1.5 py-0.5 rounded">${i.store}</span> <span class="text-sm text-slate-300">${i.desc}</span></div>
                                            <span class="text-xs text-red-400 border border-red-400/30 px-2 py-1 rounded">${i.type}</span>
                                        </div>
                                    `).join('') || '<p class="text-slate-500 text-center mt-10">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>'}
                                </div>
                                <button onclick="app.openAiModal('hq')" class="w-full mt-3 bg-blue-600 text-white py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-500 transition-colors">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i> AI ì£¼ê°„ íšŒì˜ ìë£Œ ìƒì„±
                                </button>
                            </div>
                        </div>
                    </div>`;
            },

            getHQSalesHTML(data) {
                return `
                    <div class="space-y-6 fade-in pb-20">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                             <h3 class="text-base font-bold text-white mb-4">ì±„ë„ë³„ ë§¤ì¶œ êµ¬ì„±</h3>
                             <div id="chart-channel" class="h-[300px] w-full"></div>
                        </div>
                        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-850 border-b border-slate-800">
                                    <tr><th class="px-6 py-3">ë‚ ì§œ</th><th class="px-6 py-3 text-right">ë§¤ì¶œ</th><th class="px-6 py-3 text-right">í™€</th><th class="px-6 py-3 text-right">ë°°ë‹¬</th></tr>
                                </thead>
                                <tbody>
                                    ${data.sales.dates.map((d, i) => `
                                        <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                            <td class="px-6 py-4 font-medium text-white">${d}</td>
                                            <td class="px-6 py-4 text-right text-white">${data.sales.daily[i].toLocaleString()}ì›</td>
                                            <td class="px-6 py-4 text-right">${Math.floor(data.sales.daily[i] * (data.sales.channel[0]/100)).toLocaleString()}ì›</td>
                                            <td class="px-6 py-4 text-right">${Math.floor(data.sales.daily[i] * (data.sales.channel[1]/100)).toLocaleString()}ì›</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            },

            getHQStoresHTML() {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in pb-20">
                        ${STORE_LIST.map(s => `
                            <div class="bg-slate-900 border ${s.risk === 'High' ? 'border-red-500/50' : 'border-slate-800'} rounded-xl p-6 hover:shadow-lg transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h3 class="text-lg font-bold text-white">${s.name}</h3>
                                            <span class="px-2 py-0.5 text-[10px] rounded ${s.status==='OPEN'?'bg-green-500/20 text-green-400':'bg-slate-700 text-slate-400'}">${s.status}</span>
                                        </div>
                                        <p class="text-sm text-slate-400 mt-1">ì ì£¼: ${s.owner}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold text-white">${s.sales}</p>
                                        <p class="text-xs text-slate-500">ëª©í‘œ ${s.rate}%</p>
                                    </div>
                                </div>
                                <div class="h-2 bg-slate-800 rounded-full overflow-hidden mb-4">
                                    <div class="h-full bg-blue-600" style="width: ${s.rate}%"></div>
                                </div>
                                <div class="flex justify-between items-center text-sm pt-4 border-t border-slate-800">
                                    <span class="text-slate-400">Risk Level</span>
                                    <span class="${s.risk==='High'?'text-red-400 font-bold':'text-green-400'}">${s.risk}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            },

            // --- HTML Generators (Partner) ---
            getPartnerHomeHTML() {
                return `
                    <div class="space-y-6 fade-in pb-20">
                        <div class="bg-gradient-to-r from-indigo-900 to-slate-900 p-6 rounded-xl border border-indigo-500/30 shadow-lg flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-1">ì˜¤ëŠ˜ë„ ëŒ€ë°•ë‚˜ì„¸ìš”! ğŸ”¥</h3>
                                <p class="text-indigo-200 text-sm">í˜„ì¬ ëª©í‘œ ë§¤ì¶œ ë‹¬ì„±ë¥  <span class="font-bold text-white">92%</span></p>
                            </div>
                            <div class="text-right hidden md:block">
                                <p class="text-slate-400 text-xs">ì‹¤ì‹œê°„ ì˜ˆìƒ ì´ìµ</p>
                                <p class="text-2xl font-bold text-white">â‚©345,000</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${this.kpiCard('ì˜¤ëŠ˜ ë§¤ì¶œ', '1,250,000ì›', 15.2, 'dollar-sign', 'indigo')}
                            ${this.kpiCard('ì£¼ë¬¸ ê±´ìˆ˜', '48ê±´', 8.5, 'shopping-bag', 'green')}
                            ${this.kpiCard('ê³ ê° í‰ì ', '4.9', 0.1, 'star', 'amber')}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                                <h3 class="text-base font-bold text-white mb-4">ì£¼ê°„ ë§¤ì¶œ íŠ¸ë Œë“œ</h3>
                                <div id="chart-home" class="h-[250px]"></div>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                                    <h3 class="text-base font-bold text-white mb-3 flex items-center gap-2"><i data-lucide="bell" class="w-4 h-4 text-amber-400"></i> ì•Œë¦¼</h3>
                                    <div class="space-y-3">
                                        <div class="flex gap-3 text-sm p-2 bg-slate-800/50 rounded"><span class="text-amber-400 font-bold">[ì¬ê³ ]</span> <span class="text-slate-300">ë¸Œë¦¬ì˜¤ìŠˆ ë²ˆ 15ê°œ ë‚¨ìŒ</span></div>
                                        <div class="flex gap-3 text-sm p-2 bg-slate-800/50 rounded"><span class="text-blue-400 font-bold">[ë¦¬ë·°]</span> <span class="text-slate-300">ì‹ ê·œ 5ì  ë¦¬ë·° ë“±ë¡ë¨</span></div>
                                    </div>
                                </div>
                                <button onclick="app.openAiModal('partner')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all">
                                    <i data-lucide="clipboard-check"></i> ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸ (1ì½”ì¸)
                                </button>
                            </div>
                        </div>
                    </div>`;
            },

            getPartnerSalesHTML() {
                const sales = DB.gangnam.sales;
                return `
                    <div class="space-y-6 fade-in pb-20">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-white mb-6">11ì›” ì†ìµ ê³„ì‚°ì„œ (ì¶”ì •)</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between border-b border-slate-800 pb-4"><span class="text-slate-400">ì´ ë§¤ì¶œ</span><span class="text-2xl font-bold text-white">â‚©${sales.total.toLocaleString()}</span></div>
                                <div class="flex justify-between text-sm text-red-400"><span>(-) ì‹ìì¬ ì›ê°€</span><span>-â‚©${sales.cost.toLocaleString()}</span></div>
                                <div class="flex justify-between text-sm text-red-400"><span>(-) ë°°ë‹¬ ëŒ€í–‰ë¹„</span><span>-â‚©${sales.delivery.toLocaleString()}</span></div>
                                <div class="flex justify-between pt-4 border-t border-slate-700"><span class="text-indigo-400 font-bold">ì˜ì—… ì´ìµ</span><span class="text-2xl font-bold text-indigo-400">â‚©${sales.profit.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>`;
            },

            getPartnerMenuHTML() {
                return `
                    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden fade-in">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-850 border-b border-slate-800"><tr><th class="px-6 py-3">ë©”ë‰´ëª…</th><th class="px-6 py-3 text-right">ìˆ˜ëŸ‰</th><th class="px-6 py-3 text-right">ë§¤ì¶œ</th><th class="px-6 py-3 text-center">ë§ˆì§„</th></tr></thead>
                            <tbody>
                                ${DB.gangnam.menus.map(m => `<tr class="border-b border-slate-800"><td class="px-6 py-4 font-medium text-white">${m.name}</td><td class="px-6 py-4 text-right">${m.qty}</td><td class="px-6 py-4 text-right">â‚©${m.sales.toLocaleString()}</td><td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${m.margin==='High'?'bg-green-500/20 text-green-400':'bg-blue-500/20 text-blue-400'}">${m.margin}</span></td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
            },

            getPartnerReviewsHTML() {
                return `
                    <div class="space-y-4 fade-in pb-20">
                        ${DB.gangnam.reviews.map(r => `
                            <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                                <div class="flex justify-between mb-2"><div class="flex items-center gap-2"><span class="font-bold text-white">${r.user}</span><div class="text-amber-400 text-xs">â˜…â˜…â˜…â˜…â˜…</div></div><span class="text-xs text-slate-500">${r.date}</span></div>
                                <p class="text-slate-300 text-sm bg-slate-800/50 p-3 rounded-lg">${r.content}</p>
                                ${!r.reply ? `<div class="flex justify-end gap-2 mt-3"><button class="px-3 py-1.5 bg-indigo-600 text-white text-xs rounded flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> AI ë‹µê¸€</button></div>` : ''}
                            </div>
                        `).join('')}
                    </div>`;
            },

            kpiCard(title, value, trend, icon, color) {
                const colors = { blue: 'text-blue-400 bg-blue-500/10', indigo: 'text-indigo-400 bg-indigo-500/10', emerald: 'text-emerald-400 bg-emerald-500/10', amber: 'text-amber-400 bg-amber-500/10', purple: 'text-purple-400 bg-purple-500/10' };
                return `
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <div class="flex justify-between mb-2"><span class="text-slate-400 text-xs font-bold uppercase">${title}</span><div class="${colors[color]} p-2 rounded-lg"><i data-lucide="${icon}" class="w-4 h-4"></i></div></div>
                        <div class="flex items-end gap-2"><h3 class="text-2xl font-bold text-white">${value}</h3><span class="text-xs ${trend>=0?'text-green-400':'text-red-400'} mb-1">${trend>=0?'+':''}${trend}%</span></div>
                    </div>`;
            },

            renderChart(data, type, elementId) {
                setTimeout(() => {
                    if(!document.getElementById(elementId)) return;
                    document.getElementById(elementId).innerHTML = ""; // Clear previous
                    const options = {
                        series: type === 'area' ? [{ name: 'Value', data: data }] : data,
                        chart: { type: type, height: '100%', background: 'transparent', toolbar: { show: false }, fontFamily: 'Pretendard' },
                        theme: { mode: 'dark' },
                        stroke: { curve: 'smooth', width: 2, colors: [this.userType==='hq'?'#3b82f6':'#6366f1'] },
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.0 } },
                        dataLabels: { enabled: false },
                        labels: type === 'donut' ? ['í™€', 'ë°°ë‹¬'] : undefined,
                        colors: type === 'donut' ? ['#3b82f6', '#f59e0b'] : undefined,
                        legend: { position: 'bottom' },
                        grid: { borderColor: '#334155', strokeDashArray: 4 }
                    };
                    if(type === 'area') options.xaxis = { categories: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], labels: { style: { colors: '#94a3b8' } }, axisBorder: { show: false }, axisTicks: { show: false } };
                    
                    new ApexCharts(document.querySelector(`#${elementId}`), options).render();
                }, 50);
            },

            // --- AI & Chat ---
            openAiModal(type) {
                document.getElementById('ai-modal').classList.remove('hidden-force');
                const title = type === 'hq' ? 'AI ì£¼ê°„ íšŒì˜ ë¦¬í¬íŠ¸' : 'AI ë§¤ì¥ ì ê²€ ë¦¬í¬íŠ¸';
                const desc = type === 'hq' ? 'ì „ì‚¬ ë§¤ì¶œ ë°ì´í„°ì™€ OKR íšŒì˜ë¡ì„ ë¶„ì„í•©ë‹ˆë‹¤.' : 'ìš°ë¦¬ ë§¤ì¥ì˜ ë§¤ì¶œê³¼ ë¦¬ë·°ë¥¼ ë¶„ì„í•˜ì—¬ ê°œì„ ì ì„ ì°¾ìŠµë‹ˆë‹¤.';
                const color = type === 'hq' ? 'bg-blue-600 hover:bg-blue-500' : 'bg-indigo-600 hover:bg-indigo-500';
                
                document.getElementById('ai-modal-title').innerText = title;
                document.getElementById('ai-content-area').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div class="w-16 h-16 ${color}/20 rounded-full flex items-center justify-center mb-4"><i data-lucide="sparkles" class="w-8 h-8 text-white"></i></div>
                        <h3 class="text-xl font-bold text-white mb-2">${title}</h3>
                        <p class="text-slate-400 mb-6 text-sm">${desc}</p>
                        <button onclick="app.generateReport('${type}')" class="px-6 py-3 ${color} text-white rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg">
                            <i data-lucide="zap" class="w-4 h-4"></i> ë¦¬í¬íŠ¸ ìƒì„± (${type==='hq'?5:1}ì½”ì¸)
                        </button>
                    </div>`;
                lucide.createIcons();
            },

            async generateReport(type) {
                const cost = type === 'hq' ? 5 : 1;
                if (this.coins < cost) return app.openAdModal();
                
                this.coins -= cost;
                document.getElementById('coin-disp').innerText = this.coins;
                
                const content = document.getElementById('ai-content-area');
                content.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white mb-4"></div><p class="text-white font-bold animate-pulse">Gemini 2.5ê°€ ë¶„ì„ ì¤‘...</p></div>`;

                const prompt = type === 'hq' 
                    ? `[Role] COO. [Data] ${JSON.stringify(DB.all)}. [Context] ${DB.okr_context}. Write Weekly Report (Korean).`
                    : `[Role] Store Owner. [Data] ${JSON.stringify(DB.gangnam)}. Write Store Checkup Report (Korean).`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const json = await response.json();
                    const text = json.candidates[0].content.parts[0].text;
                    const html = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>').replace(/## (.*?)(<br>|$)/g, '<h3 class="text-lg font-bold text-white mt-6 mb-2 border-b border-slate-700 pb-2">$1</h3>');
                    content.innerHTML = `<div class="max-w-2xl mx-auto">${html}</div>`;
                } catch(e) {
                    content.innerHTML = `<div class="text-center text-red-400">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</div>`;
                }
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const msg = input.value;
                if(!msg.trim()) return;
                
                const box = document.getElementById('chat-messages');
                const userColor = this.userType === 'hq' ? 'bg-blue-600' : 'bg-indigo-600';
                box.innerHTML += `<div class="flex justify-end"><div class="${userColor} text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[90%] mb-2">${msg}</div></div>`;
                input.value = '';
                box.scrollTop = box.scrollHeight;

                try {
                    const prompt = `[System] Role: ${this.userType} AI Assistant. Context: ${JSON.stringify(DB[this.storeId] || DB.all)}. Question: ${msg}. Answer in Korean.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const json = await response.json();
                    const text = json.candidates[0].content.parts[0].text;
                    box.innerHTML += `<div class="flex justify-start"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none text-sm max-w-[90%] border border-slate-700 mb-2 shadow-sm">${text}</div></div>`;
                } catch(e) {
                    box.innerHTML += `<div class="flex justify-start"><div class="bg-red-900/50 text-red-200 p-2 rounded text-xs">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div></div>`;
                }
                box.scrollTop = box.scrollHeight;
            },

            // --- Ads ---
            openAdModal() {
                document.getElementById('ad-modal').classList.remove('hidden-force');
                let w = 0;
                const bar = document.getElementById('ad-progress');
                const btn = document.getElementById('ad-close-btn');
                btn.disabled = true; btn.innerText = "ì‹œì²­ ì¤‘..."; btn.className = "w-full py-3 rounded-lg font-bold bg-slate-200 text-slate-400";
                const t = setInterval(() => { w+=2; bar.style.width=w+'%'; if(w>=100){ clearInterval(t); btn.disabled=false; btn.innerText="ë³´ìƒ ë°›ê¸°"; btn.className="w-full py-3 rounded-lg font-bold bg-indigo-600 text-white"; } }, 30);
            },
            completeAd() { this.coins+=10; document.getElementById('coin-disp').innerText=this.coins; document.getElementById('ad-modal').classList.add('hidden-force'); }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
