<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoGenie Partner</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 14px; margin-bottom: 10px; }
        .chat-user { background-color: #2563eb; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-bot { background-color: white; color: #1e293b; border-bottom-left-radius: 4px; margin-right: auto; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer } = Recharts;
        
        const API_KEY = ""; // System prompt: Use empty string as key is injected by environment
        const PARTNER_CONTEXT = `
            [매장 데이터: 슬램버거 강남점]
            - 10월 매출: 9,885만원 (목표 달성).
            - 주요 메뉴: 갈비버거 세트(판매 1위), 더블치즈버거.
            - 매뉴얼: 갈비버거 소스는 번 하단에 마요네즈 10g, 패티 위에 갈비소스 25g(1펌프) 정량 준수.
            - 위생: 마감 시 주방 후드 필터 분리 세척 필수.
            - 이슈: 브리오슈 번 재고 부족 알림 발생 중.
        `;

        // Chatbot
        const PartnerChatbot = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([{ role: 'model', text: '사장님, 안녕하세요! 무엇을 도와드릴까요?' }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

            const send = async () => {
                if (!input.trim()) return;
                const msg = input;
                setMessages(prev => [...prev, { role: 'user', text: msg }]);
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: "user", parts: [{ text: `Context: ${PARTNER_CONTEXT}\n\nUser: ${msg}\n\nAnswer as a store manager AI.` }] }]
                        })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { role: 'model', text: data.candidates[0].content.parts[0].text }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'model', text: '오류가 발생했습니다.' }]);
                } finally {
                    setLoading(false);
                }
            };

            if (!isOpen) return (
                <button onClick={()=>setIsOpen(true)} className="fixed bottom-20 right-4 bg-blue-600 text-white p-4 rounded-full shadow-xl z-50">
                    <i data-lucide="message-circle" className="w-6 h-6"></i>
                </button>
            );

            return (
                <div className="fixed inset-0 z-50 bg-white flex flex-col md:inset-auto md:bottom-20 md:right-4 md:w-96 md:h-[500px] md:rounded-2xl md:shadow-2xl md:border">
                    <div className="p-4 bg-blue-600 text-white flex justify-between items-center shadow-sm">
                        <span className="font-bold flex items-center gap-2"><i data-lucide="bot" className="w-5 h-5"></i> 슬램지니</span>
                        <button onClick={()=>setIsOpen(false)}><i data-lucide="x" className="w-5 h-5"></i></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 bg-slate-50" ref={scrollRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`chat-bubble ${m.role==='user'?'chat-user':'chat-bot'}`}>{m.text}</div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 ml-2">답변 작성 중...</div>}
                    </div>
                    <div className="p-3 border-t bg-white flex gap-2 pb-safe">
                        <input type="text" className="flex-1 border rounded-xl px-4 py-3 outline-none focus:border-blue-500" placeholder="질문 입력..." value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} />
                        <button onClick={send} className="bg-blue-600 text-white p-3 rounded-xl"><i data-lucide="send" className="w-5 h-5"></i></button>
                    </div>
                </div>
            );
        };

        // Dashboard Logic (Simplified)
        const Dashboard = () => {
            const data = { todaySales: 3850510, monthProfit: 21500000, costBreakdown: [{name:'재료',value:36,color:'#3b82f6'},{name:'이익',value:21,color:'#22c55e'},{name:'기타',value:43,color:'#e2e8f0'}] };
            return (
                <div className="pb-24 animate-fade-in">
                    <div className="bg-blue-600 pt-12 pb-16 px-6 rounded-b-[2rem] shadow-lg relative text-white">
                        <h2 className="text-2xl font-bold mb-4">안녕하세요, 사장님!</h2>
                        <div className="bg-white/10 backdrop-blur p-4 rounded-xl border border-white/20 text-sm">
                            <div className="flex gap-2 mb-2"><i data-lucide="sparkles" className="text-yellow-300 w-4 h-4"></i> <span>내일 비 예보: 배달 광고 증액 제안</span></div>
                            <div className="flex gap-2"><i data-lucide="package" className="text-red-300 w-4 h-4"></i> <span>브리오슈 번 재고 부족 알림</span></div>
                        </div>
                    </div>
                    <div className="px-6 -mt-8 grid grid-cols-2 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-md"><p className="text-slate-400 text-xs mb-1">오늘 매출</p><h3 className="text-xl font-bold">₩{data.todaySales.toLocaleString()}</h3></div>
                        <div className="bg-white p-5 rounded-2xl shadow-md"><p className="text-slate-400 text-xs mb-1">예상 순수익</p><h3 className="text-xl font-bold text-blue-600">₩{data.monthProfit.toLocaleString()}</h3></div>
                    </div>
                    <div className="px-6 mt-6">
                         <h3 className="font-bold text-lg mb-4">수익성 분석</h3>
                         <div className="bg-white p-6 rounded-3xl shadow-sm h-64">
                            <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={data.costBreakdown} innerRadius={60} outerRadius={80} dataKey="value"><Cell fill="#3b82f6"/><Cell fill="#22c55e"/><Cell fill="#cbd5e1"/></Pie></PieChart></ResponsiveContainer>
                         </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [tab, setTab] = useState('home');
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); });

            if (!isLoggedIn) return <div className="h-screen flex items-center justify-center"><button onClick={()=>setIsLoggedIn(true)} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">사장님 로그인</button></div>;

            return (
                <div className="bg-slate-50 min-h-screen max-w-md mx-auto shadow-2xl relative overflow-hidden">
                    {tab === 'home' && <Dashboard />}
                    <PartnerChatbot />
                    <nav className="fixed bottom-0 w-full max-w-md bg-white border-t flex justify-around py-3 pb-safe z-40 rounded-t-2xl">
                        {['home','pie-chart','zap','menu'].map((icon,i) => (
                            <button key={i} onClick={()=>setTab(icon==='home'?'home':'other')} className={`flex flex-col items-center ${tab===(icon==='home'?'home':'other')?'text-blue-600':'text-slate-300'}`}><i data-lucide={icon} className="w-6 h-6"></i></button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
